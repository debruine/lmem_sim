<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Appendix 3b: Extended Binomial Example • lmem.sim</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Appendix 3b: Extended Binomial Example">
<meta property="og:description" content="lmem.sim">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">lmem.sim</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/paper.html">Understanding mixed effects models through data simulation</a>
    </li>
    <li>
      <a href="../articles/appendix1a_example_code.html">Appendix 1a: Example Code</a>
    </li>
    <li>
      <a href="../articles/appendix1b_example_code.html">Appendix 1b: Example Code (no tidyverse)</a>
    </li>
    <li>
      <a href="../articles/appendix1c_sensitivity.html">Appendix 1c: Sensitivity Analysis</a>
    </li>
    <li>
      <a href="../articles/appendix2_extended_example.html">Appendix 2: Extended Examples</a>
    </li>
    <li>
      <a href="../articles/appendix3a_binomial.html">Appendix 3a: Binomial Example</a>
    </li>
    <li>
      <a href="../articles/appendix3b_extended_binomial.html">Appendix 3b: Extended Binomial Example</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="appendix3b_extended_binomial_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Appendix 3b: Extended Binomial Example</h1>
            <h3 class="subtitle">Understanding mixed effects models through data simulation</h3>
                        <h4 class="author">Lisa M. DeBruine &amp; Dale J. Barr</h4>
            
      
      
      <div class="hidden name"><code>appendix3b_extended_binomial.Rmd</code></div>

    </div>

    
    
<p><a href="https://github.com/debruine/lmem_sim/blob/master/vignettes/appendix3b_extended_binomial.Rmd">Download the .Rmd for this example</a></p>
<div id="simulating-binomial-data-with-crossed-random-factors" class="section level2">
<h2 class="hasAnchor">
<a href="#simulating-binomial-data-with-crossed-random-factors" class="anchor"></a>Simulating binomial data with crossed random factors</h2>
<p>To give an overview of the simulation task, we will simulate data from a design with crossed random factors of subjects and stimuli, fit a model to the simulated data, and then try to recover the parameter values we put in from the output. In this hypothetical study, subjects classify the emotional expressions of faces as quickly as possible, and we use accuracy (correct/incorrect) as the primary dependent variable. The faces are of two types: either from the subject’s ingroup or from an outgroup. For simplicity, we further assume that each face appears only once in the stimulus set. The key question is whether there is any difference in classification accuracy across the type of face.</p>
<p>The important parts of the design are:</p>
<ul>
<li>Random factor 1: subjects</li>
<li>Random factor 2: faces</li>
<li>Fixed factor 1: expression (level = angry, happy)
<ul>
<li>within subject: subjects see both angry and happy faces</li>
<li>within face: faces are both angry and happy</li>
</ul>
</li>
<li>Fixed factor 1: category (level = ingroup, outgroup)
<ul>
<li>within subject: subjects see both ingroup and outgroup faces</li>
<li>between face: faces are either ingroup or outgroup</li>
</ul>
</li>
</ul>
<div id="required-software" class="section level3">
<h3 class="hasAnchor">
<a href="#required-software" class="anchor"></a>Required software</h3>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="co"># load required packages</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/lme4/lme4/">"lme4"</a></span><span class="op">)</span>        <span class="co"># model specification / estimation</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="http://afex.singmann.science/">"afex"</a></span><span class="op">)</span>        <span class="co"># anova and deriving p-values from lmer</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="http://github.com/bbolker/broom.mixed">"broom.mixed"</a></span><span class="op">)</span> <span class="co"># extracting data from model fits </span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/debruine/faux">"faux"</a></span><span class="op">)</span>        <span class="co"># data simulation</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="http://tidyverse.tidyverse.org">"tidyverse"</a></span><span class="op">)</span>   <span class="co"># data wrangling and visualisation</span>

<span class="co"># ensure this script returns the same results on each run</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">8675309</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/faux/man/faux_options.html">faux_options</a></span><span class="op">(</span>verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></pre></div>
<p>This example presents an extended simulation for a binomial logistic mixed regression. Part of the process involves conversion between probability and the logit function of probability. The code below converts between these.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="va">logit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">x</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">}</span>
<span class="va">inv_logit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">.01</span><span class="op">)</span>
<span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>logit <span class="op">=</span> <span class="fu">logit</span><span class="op">(</span><span class="va">prob</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">prob</span>, <span class="va">logit</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span></pre></div>
<p><img src="appendix3b_extended_binomial_files/figure-html/unnamed-chunk-2-1.png" width="100%"></p>
</div>
</div>
<div id="ww2wb-design" class="section level2">
<h2 class="hasAnchor">
<a href="#ww2wb-design" class="anchor"></a>2ww*2wb design</h2>
<p>In this example, 100 subjects will respond twice (for happy and angry expressions) to 50 items; 25 items in each of 2 categories. In this example, <code>expression</code> is a within-subject and within-item factor and <code>category</code> is a within-subject and between-item factor.</p>
<p>We use the following prefixes to designate model parameters and sampled values: * <code>beta_*</code>: fixed effect parameters * <code>subj_*</code>: random effect parameters associated with subjects * <code>item_*</code>: random effect parameters associated with items * <code>X_*</code>: effect-coded predictor * <code>S_*</code>: sampled values for subject random effects * <code>I_*</code>: sampled values for item random effects</p>
<p>In previous tutorials, we used numbers to designate fixed effects, but here we will use letter abbreviations to make things clearer:</p>
<ul>
<li>
<code>*_0</code>: intercept</li>
<li>
<code>*_e</code>: expression</li>
<li>
<code>*_c</code>: category</li>
<li>
<code>*_ec</code>: expression * category</li>
</ul>
<p>Other terms:</p>
<ul>
<li>
<code>*_rho</code>: correlations; a vector of the upper right triangle for the correlation matrix for that group’s random effects</li>
<li>
<code>n_*</code>: sample size</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="va">ext_bin_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span>
  <span class="va">n_subj</span>     <span class="op">=</span> <span class="fl">100</span>, <span class="co"># number of subjects</span>
  <span class="va">n_ingroup</span>  <span class="op">=</span>  <span class="fl">25</span>,  <span class="co"># number of faces in ingroup</span>
  <span class="va">n_outgroup</span> <span class="op">=</span>  <span class="fl">25</span>,  <span class="co"># number of faces in outgroup</span>
  <span class="va">beta_0</span>     <span class="op">=</span>   <span class="fl">0</span>, <span class="co"># grand mean</span>
  <span class="va">beta_e</span>     <span class="op">=</span>   <span class="fl">0</span>, <span class="co"># main effect of expression</span>
  <span class="va">beta_c</span>     <span class="op">=</span>   <span class="fl">0</span>, <span class="co"># main effect of category</span>
  <span class="va">beta_ec</span>    <span class="op">=</span>   <span class="fl">0</span>, <span class="co"># interaction between category and expression</span>
  <span class="va">item_0</span>    <span class="op">=</span>   <span class="fl">1</span>, <span class="co"># by-item random intercept sd</span>
  <span class="va">item_e</span>     <span class="op">=</span>   <span class="fl">1</span>, <span class="co"># by-item random slope for exp</span>
  <span class="va">item_rho</span>   <span class="op">=</span>   <span class="fl">0</span>, <span class="co"># by-item random effect correlation</span>
  <span class="va">subj_0</span>     <span class="op">=</span>   <span class="fl">1</span>, <span class="co"># by-subject random intercept sd</span>
  <span class="va">subj_e</span>     <span class="op">=</span>   <span class="fl">1</span>, <span class="co"># by-subject random slope sd for exp</span>
  <span class="va">subj_c</span>     <span class="op">=</span>   <span class="fl">1</span>, <span class="co"># by-subject random slope sd for category</span>
  <span class="va">subj_ec</span>    <span class="op">=</span>   <span class="fl">1</span>, <span class="co"># by-subject random slope sd for category*exp</span>
  <span class="co"># by-subject random effect correlations</span>
  <span class="va">subj_rho</span>   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="co"># subj_0  * subj_e, subj_c, subj_ec</span>
                    <span class="fl">0</span>, <span class="fl">0</span>, <span class="co"># subj_e  *         subj_c, subj_ec</span>
                       <span class="fl">0</span><span class="op">)</span> <span class="co"># subj_c  *                 subj_ec</span>
<span class="op">)</span> <span class="op">{</span>

  <span class="co"># simulate items</span>
  <span class="va">items</span> <span class="op">&lt;-</span> <span class="fu">faux</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/faux/man/rnorm_multi.html">rnorm_multi</a></span><span class="op">(</span>
    n <span class="op">=</span> <span class="va">n_ingroup</span> <span class="op">+</span> <span class="va">n_outgroup</span>,
    mu <span class="op">=</span> <span class="fl">0</span>, 
    sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">item_0</span>, <span class="va">item_e</span><span class="op">)</span>,
    r <span class="op">=</span> <span class="va">item_rho</span>,
    varnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"I_0"</span>, <span class="st">"I_e"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span>item_id <span class="op">=</span> <span class="fu">faux</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/faux/man/make_id.html">make_id</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="st">"I"</span><span class="op">)</span>,
           category <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ingroup"</span>, <span class="st">"outgroup"</span><span class="op">)</span>, 
                           <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n_ingroup</span>, <span class="va">n_outgroup</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

   <span class="co"># simulate subjects</span>
  <span class="va">subjects</span> <span class="op">&lt;-</span> <span class="fu">faux</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/faux/man/rnorm_multi.html">rnorm_multi</a></span><span class="op">(</span>
    n <span class="op">=</span> <span class="va">n_subj</span>,
    mu <span class="op">=</span> <span class="fl">0</span>,
    sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">subj_0</span>, <span class="va">subj_e</span>, <span class="va">subj_c</span>, <span class="va">subj_ec</span><span class="op">)</span>, 
    r <span class="op">=</span> <span class="va">subj_rho</span>,
    varnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"S_0"</span>, <span class="st">"S_e"</span>, <span class="st">"S_c"</span>, <span class="st">"S_ec"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span>subj_id <span class="op">=</span> <span class="fu">faux</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/faux/man/make_id.html">make_id</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="st">"S"</span><span class="op">)</span><span class="op">)</span>

  <span class="co"># simulate trials</span>
  <span class="co"># simulate trials</span>
  <span class="fu">crossing</span><span class="op">(</span><span class="va">subjects</span>, <span class="va">items</span>,
    expression <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"happy"</span>, <span class="st">"angry"</span><span class="op">)</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span>
      <span class="co"># effect code the two fixed factors</span>
      X_e <span class="op">=</span> <span class="fu">recode</span><span class="op">(</span><span class="va">expression</span>, <span class="st">"happy"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">0.5</span>, <span class="st">"angry"</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,
      X_c <span class="op">=</span> <span class="fu">recode</span><span class="op">(</span><span class="va">category</span>, <span class="st">"ingroup"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">0.5</span>, <span class="st">"outgroup"</span> <span class="op">=</span> <span class="op">+</span><span class="fl">0.5</span><span class="op">)</span>,
      <span class="co"># add together fixed and random effects for each effect</span>
      B_0  <span class="op">=</span> <span class="va">beta_0</span>  <span class="op">+</span> <span class="va">S_0</span> <span class="op">+</span> <span class="va">I_0</span>,
      B_e  <span class="op">=</span> <span class="va">beta_e</span>  <span class="op">+</span> <span class="va">S_e</span> <span class="op">+</span> <span class="va">I_e</span>,
      B_c  <span class="op">=</span> <span class="va">beta_c</span>  <span class="op">+</span> <span class="va">S_c</span>,
      B_ec <span class="op">=</span> <span class="va">beta_ec</span> <span class="op">+</span> <span class="va">S_ec</span>,
      <span class="co"># calculate gaussian effect</span>
      Y <span class="op">=</span> <span class="va">B_0</span> <span class="op">+</span> <span class="op">(</span><span class="va">B_e</span><span class="op">*</span><span class="va">X_e</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">B_c</span><span class="op">*</span><span class="va">X_c</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">B_ec</span><span class="op">*</span><span class="va">X_e</span><span class="op">*</span><span class="va">X_c</span><span class="op">)</span>,
      pr <span class="op">=</span> <span class="fu">inv_logit</span><span class="op">(</span><span class="va">Y</span><span class="op">)</span>, <span class="co"># transform to probability of getting 1</span>
      Y_bin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">pr</span><span class="op">)</span> <span class="co"># sample from bernoulli distribution</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">select</span><span class="op">(</span><span class="va">subj_id</span>, <span class="va">item_id</span>, <span class="va">expression</span>, <span class="va">category</span>, <span class="va">X_e</span>, <span class="va">X_c</span>, <span class="va">Y</span>, <span class="va">Y_bin</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="va">dat_sim</span> <span class="op">&lt;-</span> <span class="fu">ext_bin_data</span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">dat_sim</span><span class="op">)</span></pre></div>
<pre><code>## # A tibble: 6 x 8
##   subj_id item_id expression category   X_e   X_c     Y Y_bin
##   &lt;chr&gt;   &lt;chr&gt;   &lt;ord&gt;      &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;
## 1 S100    I50     angry      outgroup   0.5   0.5 -4.90     0
## 2 S100    I50     happy      outgroup  -0.5   0.5 -4.62     0
## 3 S100    I29     angry      outgroup   0.5   0.5 -4.65     0
## 4 S100    I29     happy      outgroup  -0.5   0.5 -4.15     0
## 5 S100    I11     angry      ingroup    0.5  -0.5 -5.85     0
## 6 S100    I11     happy      ingroup   -0.5  -0.5 -2.50     0</code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="va">single_run2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">filename</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">dat_sim</span> <span class="op">&lt;-</span> <span class="fu">ext_bin_data</span><span class="op">(</span><span class="va">...</span><span class="op">)</span>
  <span class="va">mod_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer</a></span><span class="op">(</span><span class="va">Y_bin</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">X_e</span><span class="op">*</span><span class="va">X_c</span> <span class="op">+</span> 
                     <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">X_e</span> <span class="op">|</span> <span class="va">item_id</span><span class="op">)</span> <span class="op">+</span> 
                     <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">X_e</span><span class="op">*</span><span class="va">X_c</span> <span class="op">|</span> <span class="va">subj_id</span><span class="op">)</span>,
                data <span class="op">=</span> <span class="va">dat_sim</span>, family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span>
  
  <span class="va">sim_results</span> <span class="op">&lt;-</span> <span class="fu">broom.mixed</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/generics/man/tidy.html">tidy</a></span><span class="op">(</span><span class="va">mod_sim</span><span class="op">)</span>
  
  <span class="co"># append the results to a file if filename is set</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">filename</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">append</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="va">filename</span><span class="op">)</span> <span class="co"># append if the file exists</span>
    <span class="fu">write_csv</span><span class="op">(</span><span class="va">sim_results</span>, <span class="va">filename</span>, append <span class="op">=</span> <span class="va">append</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="co"># return the tidy table</span>
  <span class="va">sim_results</span>
<span class="op">}</span></pre></div>
<p>The following function calculate the betas from probabilities for each cell. You will need to figure out a custom function for each design to do this, or estimate fixed effect parameters from analysis of pilot data.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="va">prob2param</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">angry_ingroup</span> <span class="op">=</span> <span class="fl">0</span>,
                       <span class="va">angry_outgroup</span> <span class="op">=</span> <span class="fl">0</span>,
                       <span class="va">happy_ingroup</span> <span class="op">=</span> <span class="fl">0</span>,
                       <span class="va">happy_outgroup</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">ai</span> <span class="op">&lt;-</span> <span class="fu">logit</span><span class="op">(</span><span class="va">angry_ingroup</span><span class="op">)</span>
  <span class="va">ao</span> <span class="op">&lt;-</span> <span class="fu">logit</span><span class="op">(</span><span class="va">angry_outgroup</span><span class="op">)</span>
  <span class="va">hi</span> <span class="op">&lt;-</span> <span class="fu">logit</span><span class="op">(</span><span class="va">happy_ingroup</span><span class="op">)</span>
  <span class="va">ho</span> <span class="op">&lt;-</span> <span class="fu">logit</span><span class="op">(</span><span class="va">happy_outgroup</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    beta_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ai</span>,<span class="va">ao</span>,<span class="va">hi</span>,<span class="va">ho</span><span class="op">)</span><span class="op">)</span>, <span class="co"># grand mean</span>
    beta_e <span class="op">=</span> <span class="op">(</span><span class="va">ao</span><span class="op">+</span><span class="va">ai</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="va">ho</span><span class="op">+</span><span class="va">hi</span><span class="op">)</span>, <span class="co"># angry - happy</span>
    beta_c <span class="op">=</span> <span class="op">(</span><span class="va">ao</span><span class="op">+</span><span class="va">ho</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="va">ai</span><span class="op">+</span><span class="va">hi</span><span class="op">)</span>, <span class="co"># outgroup - ingroup</span>
    beta_ec <span class="op">=</span> <span class="op">(</span><span class="va">ao</span><span class="op">-</span><span class="va">ai</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="va">ho</span><span class="op">-</span><span class="va">hi</span><span class="op">)</span> <span class="co"># angry o-i diff - happy o-i diff</span>
  <span class="op">)</span>
<span class="op">}</span></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="co"># run simulations and save to a file on each rep</span>
<span class="va">filename</span> <span class="op">&lt;-</span> <span class="st">"sims/binomial_ext.csv"</span>
<span class="va">b</span> <span class="op">=</span> <span class="fu">prob2param</span><span class="op">(</span><span class="fl">.5</span>, <span class="fl">.6</span>, <span class="fl">.4</span>, <span class="fl">.5</span><span class="op">)</span>
<span class="va">reps</span> <span class="op">&lt;-</span> <span class="fl">10</span>

<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="va">filename</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># run simulations and save to a file</span>
  <span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_df</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">reps</span>, <span class="op">~</span><span class="fu">single_run2</span><span class="op">(</span>
    filename <span class="op">=</span> <span class="va">filename</span>,
    beta_0 <span class="op">=</span> <span class="va">b</span><span class="op">$</span><span class="va">beta_0</span>,
    beta_e <span class="op">=</span> <span class="va">b</span><span class="op">$</span><span class="va">beta_e</span>,
    beta_c <span class="op">=</span> <span class="va">b</span><span class="op">$</span><span class="va">beta_c</span>,
    beta_ec <span class="op">=</span> <span class="va">b</span><span class="op">$</span><span class="va">beta_ec</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span>

<span class="co"># read saved simulation data</span>
<span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="va">filename</span><span class="op">)</span></pre></div>
<div id="calculate-mean-estimates" class="section level3">
<h3 class="hasAnchor">
<a href="#calculate-mean-estimates" class="anchor"></a>Calculate mean estimates</h3>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="va">est</span> <span class="op">&lt;-</span> <span class="va">sims</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">effect</span> <span class="op">==</span> <span class="st">"fixed"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">term</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>
    mean_estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span>,
    .groups <span class="op">=</span> <span class="st">"drop"</span>
  <span class="op">)</span>

<span class="va">est</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>
  parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"beta_0"</span>, <span class="st">"beta_c"</span>, <span class="st">"beta_e"</span>, <span class="st">"beta_ec"</span><span class="op">)</span>,
  value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">beta_0</span>, <span class="va">b</span><span class="op">$</span><span class="va">beta_c</span>, <span class="va">b</span><span class="op">$</span><span class="va">beta_e</span>, <span class="va">b</span><span class="op">$</span><span class="va">beta_ec</span><span class="op">)</span>
<span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate_if</span><span class="op">(</span><span class="va">is.numeric</span>, <span class="va">round</span>, <span class="fl">2</span><span class="op">)</span></pre></div>
<pre><code>## # A tibble: 4 x 4
##   term        mean_estimate parameter value
##   &lt;chr&gt;               &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt;
## 1 (Intercept)          0.05 beta_0     0   
## 2 X_c                  0.88 beta_c     0.81
## 3 X_e                  0.74 beta_e     0.81
## 4 X_e:X_c             -0.1  beta_ec    0</code></pre>
</div>
<div id="calculate-probabilities" class="section level3">
<h3 class="hasAnchor">
<a href="#calculate-probabilities" class="anchor"></a>Calculate probabilities</h3>
<p>Sum estimates for each cell and use inverse logit transform to recover probabilities.</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="va">int</span> <span class="op">&lt;-</span> <span class="va">est</span><span class="op">[[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span><span class="op">]</span>
<span class="va">cat</span> <span class="op">&lt;-</span> <span class="va">est</span><span class="op">[[</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">]</span><span class="op">]</span>
<span class="va">exp</span> <span class="op">&lt;-</span> <span class="va">est</span><span class="op">[[</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">]</span><span class="op">]</span>
<span class="va">cat_exp</span> <span class="op">&lt;-</span> <span class="va">est</span><span class="op">[[</span><span class="fl">4</span>,<span class="fl">2</span><span class="op">]</span><span class="op">]</span>

<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  angry_outgroup <span class="op">=</span> <span class="fu">inv_logit</span><span class="op">(</span><span class="va">int</span> <span class="op">+</span> <span class="fl">.5</span><span class="op">*</span><span class="va">cat</span> <span class="op">+</span> <span class="fl">.5</span><span class="op">*</span><span class="va">exp</span> <span class="op">+</span> <span class="fl">.5</span><span class="op">*</span><span class="fl">.5</span><span class="op">*</span><span class="va">cat_exp</span><span class="op">)</span>,
  angry_ingroup  <span class="op">=</span> <span class="fu">inv_logit</span><span class="op">(</span><span class="va">int</span> <span class="op">-</span> <span class="fl">.5</span><span class="op">*</span><span class="va">cat</span> <span class="op">+</span> <span class="fl">.5</span><span class="op">*</span><span class="va">exp</span> <span class="op">-</span> <span class="fl">.5</span><span class="op">*</span><span class="fl">.5</span><span class="op">*</span><span class="va">cat_exp</span><span class="op">)</span>,
  happy_outgroup <span class="op">=</span> <span class="fu">inv_logit</span><span class="op">(</span><span class="va">int</span> <span class="op">+</span> <span class="fl">.5</span><span class="op">*</span><span class="va">cat</span> <span class="op">-</span> <span class="fl">.5</span><span class="op">*</span><span class="va">exp</span> <span class="op">-</span> <span class="fl">.5</span><span class="op">*</span><span class="fl">.5</span><span class="op">*</span><span class="va">cat_exp</span><span class="op">)</span>,
  happy_ingroup  <span class="op">=</span> <span class="fu">inv_logit</span><span class="op">(</span><span class="va">int</span> <span class="op">-</span> <span class="fl">.5</span><span class="op">*</span><span class="va">cat</span> <span class="op">-</span> <span class="fl">.5</span><span class="op">*</span><span class="va">exp</span> <span class="op">+</span> <span class="fl">.5</span><span class="op">*</span><span class="fl">.5</span><span class="op">*</span><span class="va">cat_exp</span><span class="op">)</span>
<span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">gather</span><span class="op">(</span><span class="va">key</span>, <span class="va">val</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">separate</span><span class="op">(</span><span class="va">key</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"exp"</span>, <span class="st">"cat"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">spread</span><span class="op">(</span><span class="va">cat</span>, <span class="va">val</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate_if</span><span class="op">(</span><span class="va">is.numeric</span>, <span class="va">round</span>, <span class="fl">2</span><span class="op">)</span></pre></div>
<pre><code>##     exp ingroup outgroup
## 1 angry    0.50     0.70
## 2 happy    0.31     0.54</code></pre>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Lisa DeBruine, Dale Barr.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
