<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Appendix 2: Extended Examples â€¢ lmem.sim</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Appendix 2: Extended Examples">
<meta property="og:description" content="lmem.sim">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">lmem.sim</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9001</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/paper.html">Understanding mixed effects models through data simulation</a>
    </li>
    <li>
      <a href="../articles/appendix1a_example_code.html">Appendix 1a: Example Code</a>
    </li>
    <li>
      <a href="../articles/appendix1b_example_code.html">Appendix 1b: Example Code (no tidyverse)</a>
    </li>
    <li>
      <a href="../articles/appendix1c_sensitivity.html">Appendix 1c: Sensitivity Analysis</a>
    </li>
    <li>
      <a href="../articles/appendix2_extended_example.html">Appendix 2: Extended Examples</a>
    </li>
    <li>
      <a href="../articles/appendix3a_binomial.html">Appendix 3a: Binomial Example</a>
    </li>
    <li>
      <a href="../articles/appendix3b_extended_binomial.html">Appendix 3b: Extended Binomial Example</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/debruine/lmem_sim/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="appendix2_extended_example_files/header-attrs-2.7/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Appendix 2: Extended Examples</h1>
            <h3 class="subtitle">Understanding mixed effects models through data simulation</h3>
                        <h4 class="author">Lisa M. DeBruine &amp; Dale J. Barr</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/debruine/lmem_sim/blob/master/vignettes/appendix2_extended_example.Rmd"><code>vignettes/appendix2_extended_example.Rmd</code></a></small>
      <div class="hidden name"><code>appendix2_extended_example.Rmd</code></div>

    </div>

    
    
<p><a href="https://github.com/debruine/lmem_sim/blob/master/vignettes/appendix2_extended_example.Rmd">Download the .Rmd for this example</a></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/lme4/lme4/">"lme4"</a></span><span class="op">)</span>        <span class="co"># model specification / estimation</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="http://afex.singmann.science/">"afex"</a></span><span class="op">)</span>        <span class="co"># deriving p-values from lmer</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="http://github.com/bbolker/broom.mixed">"broom.mixed"</a></span><span class="op">)</span> <span class="co"># extracting data from model fits </span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/debruine/faux">"faux"</a></span><span class="op">)</span>        <span class="co"># data simulation</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="http://tidyverse.tidyverse.org">"tidyverse"</a></span><span class="op">)</span>   <span class="co"># data wrangling and visualisation</span>

<span class="co"># ensure this script returns the same results on each run</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">90210</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/faux/man/faux_options.html">faux_options</a></span><span class="op">(</span>verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<div id="ww2wb-design" class="section level2">
<h2 class="hasAnchor">
<a href="#ww2wb-design" class="anchor"></a>2ww2wb Design</h2>
<p>This section will simulate data and run a power analysis for a 2x2 design where the first factor is within subjects and within items and the second factor is with subjects and between items.</p>
<div id="set-study-parameters" class="section level3">
<h3 class="hasAnchor">
<a href="#set-study-parameters" class="anchor"></a>Set Study Parameters</h3>
<p>In this example, 50 subjects will respond twice (for happy and angry expressions) to 50 items; 25 items in each of 2 categories. In this example, <code>expression</code> is a within-subject and within-item factor and <code>category</code> is a within-subject and between-item factor.</p>
<p>We will set our grand intercept and the fixed effect of category the same as before (800 ms and 50ms). We will predict that classification speed will be faster for angry than happy outgroup faces, and faster for happy than angry ingroup faces. In other words, the effect of category will be bigger for happy faces than angry faces, but there will be no main effect of expression, just an interaction between category and expression, which we will set at 70 ms (the 50ms effect of category will be 35 ms bigger for happy faces and 35 ms smaller for angry faces).</p>
<p>Therefore, you will need to set up more complicated random effect parameters. Items and subjects will need standard deviations assigned for their random intercepts and the random slopes for any within factors (and their interactions), plus the correlations among all these SDs.</p>
<p>Since all subjects respond to all items, we can set up a table of trials by crossing the subject IDs with the item IDs and also any factors that are both within-subject <em>and</em> within-item (i., <code>expression = c("happy", "angry")</code>). This is set up as a factor with the levels specified so they are displayed in the right order in plots.</p>
<p>We use the following prefixes to designate model parameters and sampled values: * <code>beta_*</code>: fixed effect parameters * <code>subj_*</code>: random effect parameters associated with subjects * <code>item_*</code>: random effect parameters associated with items * <code>X_*</code>: effect-coded predictor * <code>S_*</code>: sampled values for subject random effects * <code>I_*</code>: sampled values for item random effects</p>
<p>In previous tutorials, we used numbers to designate fixed effects, but here we will use letter abbreviations to make things clearer:</p>
<ul>
<li>
<code>*_0</code>: intercept</li>
<li>
<code>*_e</code>: expression</li>
<li>
<code>*_c</code>: category</li>
<li>
<code>*_ec</code>: expression * category</li>
</ul>
<p>Other terms:</p>
<ul>
<li>
<code>*_rho</code>: correlations; a vector of the upper right triangle for the correlation matrix for that groupâ€™s random effects</li>
<li>
<code>n_*</code>: sample size</li>
<li>
<code>sigma</code>: residual (error) sd</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># data simulation for a design with a 2x2 design where </span>
<span class="co"># the first factor is within subjects and within items, </span>
<span class="co"># and the second factor is within subjects and between items</span>

<span class="va">sim_data_2ww2wb</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span>
  <span class="va">n_subj</span>     <span class="op">=</span>  <span class="fl">50</span>, <span class="co"># number of subjects</span>
  <span class="va">n_ingroup</span>  <span class="op">=</span>  <span class="fl">25</span>, <span class="co"># number of items in ingroup</span>
  <span class="va">n_outgroup</span> <span class="op">=</span>  <span class="fl">25</span>, <span class="co"># number of items in outgroup</span>
  <span class="va">beta_0</span>     <span class="op">=</span> <span class="fl">800</span>, <span class="co"># intercept (grand mean)</span>
  <span class="va">beta_e</span>     <span class="op">=</span>  <span class="fl">50</span>, <span class="co"># main effect of category</span>
  <span class="va">beta_c</span>     <span class="op">=</span>   <span class="fl">0</span>, <span class="co"># main effect of expression</span>
  <span class="va">beta_ec</span>    <span class="op">=</span>  <span class="fl">70</span>, <span class="co"># interaction between category and expression</span>
  <span class="va">subj_0</span>     <span class="op">=</span> <span class="fl">100</span>, <span class="co"># by-subject random intercept sd</span>
  <span class="va">subj_e</span>     <span class="op">=</span>  <span class="fl">40</span>, <span class="co"># by-subject random slope sd for exp</span>
  <span class="va">subj_c</span>     <span class="op">=</span>  <span class="fl">80</span>, <span class="co"># by-subject random slope sd for category</span>
  <span class="va">subj_ec</span>    <span class="op">=</span>  <span class="fl">80</span>, <span class="co"># by-subject random slope sd for category*exp</span>
  <span class="co"># by-subject random effect correlations</span>
  <span class="va">subj_rho</span>   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.3</span>, <span class="fl">.3</span>, <span class="fl">.3</span>,   <span class="co"># beta_0 * beta_c, beta_e, beta_ce</span>
                     <span class="fl">.1</span>, <span class="fl">.1</span>,   <span class="co"># beta_c *         beta_e, beta_ce</span>
                         <span class="fl">.1</span><span class="op">)</span>,  <span class="co"># beta_e *                 beta_ce</span>
  <span class="va">item_0</span>     <span class="op">=</span>  <span class="fl">80</span>, <span class="co"># by-item random intercept sd</span>
  <span class="va">item_e</span>     <span class="op">=</span>  <span class="fl">60</span>, <span class="co"># by-item random slope for exp</span>
  <span class="va">item_rho</span>   <span class="op">=</span> <span class="fl">0.2</span>, <span class="co"># by-item random effect correlations</span>
  <span class="va">sigma</span>      <span class="op">=</span> <span class="fl">200</span>   <span class="co"># residual (error) sd</span>
<span class="op">)</span> <span class="op">{</span>

  <span class="co"># simulate items</span>
  <span class="va">items</span> <span class="op">&lt;-</span> <span class="fu">faux</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/faux/man/rnorm_multi.html">rnorm_multi</a></span><span class="op">(</span>
    n <span class="op">=</span> <span class="va">n_ingroup</span> <span class="op">+</span> <span class="va">n_outgroup</span>,
    mu <span class="op">=</span> <span class="fl">0</span>, 
    sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">item_0</span>, <span class="va">item_e</span><span class="op">)</span>,
    r <span class="op">=</span> <span class="va">item_rho</span>,
    varnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"I_0"</span>, <span class="st">"I_e"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span>item_id <span class="op">=</span> <span class="fu">faux</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/faux/man/make_id.html">make_id</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="st">"I"</span><span class="op">)</span>,
           category <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ingroup"</span>, <span class="st">"outgroup"</span><span class="op">)</span>, 
                           <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n_ingroup</span>, <span class="va">n_outgroup</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

  <span class="co"># simulate subjects</span>
  <span class="va">subjects</span> <span class="op">&lt;-</span> <span class="fu">faux</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/faux/man/rnorm_multi.html">rnorm_multi</a></span><span class="op">(</span>
    n <span class="op">=</span> <span class="va">n_subj</span>,
    mu <span class="op">=</span> <span class="fl">0</span>,
    sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">subj_0</span>, <span class="va">subj_e</span>, <span class="va">subj_c</span>, <span class="va">subj_ec</span><span class="op">)</span>, 
    r <span class="op">=</span> <span class="va">subj_rho</span>,
    varnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"S_0"</span>, <span class="st">"S_e"</span>, <span class="st">"S_c"</span>, <span class="st">"S_ec"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span>subj_id <span class="op">=</span> <span class="fu">faux</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/faux/man/make_id.html">make_id</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="st">"S"</span><span class="op">)</span><span class="op">)</span>

  <span class="co"># simulate trials</span>
  <span class="fu">crossing</span><span class="op">(</span><span class="va">subjects</span>, <span class="va">items</span>,
    expression <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"happy"</span>, <span class="st">"angry"</span><span class="op">)</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span>
      <span class="co"># effect code the two fixed factors</span>
      X_e <span class="op">=</span> <span class="fu">recode</span><span class="op">(</span><span class="va">expression</span>, <span class="st">"happy"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">0.5</span>, <span class="st">"angry"</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,
      X_c <span class="op">=</span> <span class="fu">recode</span><span class="op">(</span><span class="va">category</span>, <span class="st">"ingroup"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">0.5</span>, <span class="st">"outgroup"</span> <span class="op">=</span> <span class="op">+</span><span class="fl">0.5</span><span class="op">)</span>,
      <span class="co"># add together fixed and random effects for each effect</span>
      B_0  <span class="op">=</span> <span class="va">beta_0</span>  <span class="op">+</span> <span class="va">S_0</span> <span class="op">+</span> <span class="va">I_0</span>,
      B_e  <span class="op">=</span> <span class="va">beta_c</span>  <span class="op">+</span> <span class="va">S_e</span> <span class="op">+</span> <span class="va">I_e</span>,
      B_c  <span class="op">=</span> <span class="va">beta_e</span>  <span class="op">+</span> <span class="va">S_c</span>,
      B_ec <span class="op">=</span> <span class="va">beta_ec</span> <span class="op">+</span> <span class="va">S_ec</span>,
      <span class="co"># generate the error term</span>
      e_si <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span>,
      <span class="co"># calculate RT by adding each effect term </span>
      <span class="co"># multiplied by the relevant effect-coded factor(s)</span>
      RT <span class="op">=</span> <span class="va">B_0</span> <span class="op">+</span> <span class="op">(</span><span class="va">B_e</span><span class="op">*</span><span class="va">X_e</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">B_c</span><span class="op">*</span><span class="va">X_c</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">B_ec</span><span class="op">*</span><span class="va">X_e</span><span class="op">*</span><span class="va">X_c</span><span class="op">)</span> <span class="op">+</span> <span class="va">e_si</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">select</span><span class="op">(</span><span class="va">subj_id</span>, <span class="va">item_id</span>, <span class="va">expression</span>, <span class="va">category</span>, <span class="va">X_e</span>, <span class="va">X_c</span>, <span class="va">RT</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Plot your data to double-check it looks like you expect.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat_sim</span> <span class="op">&lt;-</span> <span class="fu">sim_data_2ww2wb</span><span class="op">(</span><span class="op">)</span>

<span class="fu">ggplot</span><span class="op">(</span><span class="va">dat_sim</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">expression</span>, <span class="va">RT</span>, color <span class="op">=</span> <span class="va">category</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_boxplot</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.25</span>, position <span class="op">=</span> <span class="fu">position_dodge</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="appendix2_extended_example_files/figure-html/unnamed-chunk-3-1.png" width="100%"></p>
</div>
<div id="analyse-data" class="section level3">
<h3 class="hasAnchor">
<a href="#analyse-data" class="anchor"></a>Analyse Data</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># set up the power function</span>
<span class="va">single_run</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">filename</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">dat_sim</span> <span class="op">&lt;-</span> <span class="fu">sim_data_2ww2wb</span><span class="op">(</span><span class="va">...</span><span class="op">)</span>
  
  <span class="va">mod_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">RT</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">X_e</span><span class="op">*</span><span class="va">X_c</span> <span class="op">+</span> 
                    <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">X_e</span> <span class="op">|</span> <span class="va">item_id</span><span class="op">)</span> <span class="op">+</span> 
                    <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">X_e</span><span class="op">*</span><span class="va">X_c</span> <span class="op">|</span> <span class="va">subj_id</span><span class="op">)</span>,
                  data <span class="op">=</span> <span class="va">dat_sim</span><span class="op">)</span>
  
  <span class="va">sim_results</span> <span class="op">&lt;-</span> <span class="fu">broom.mixed</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">mod_sim</span><span class="op">)</span>
  
  <span class="co"># append the results to a file if filename is set</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">filename</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">append</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="va">filename</span><span class="op">)</span> <span class="co"># append if the file exists</span>
    <span class="fu">write_csv</span><span class="op">(</span><span class="va">sim_results</span>, <span class="va">filename</span>, append <span class="op">=</span> <span class="va">append</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="co"># return the tidy table</span>
  <span class="va">sim_results</span>
<span class="op">}</span></code></pre></div>
<p>Run the function once with default parameters. If you run it between two calls to <code><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time()</a></code>, you can find out how long one run takes (this can be a long time for complex designs).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">start_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu">single_run</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 18 x 8
##    effect   group  term             estimate std.error statistic    df   p.value
##    &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt;               &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;
##  1 fixed    &lt;NA&gt;   (Intercept)      778.          18.3    42.6    80.9  3.52e-57
##  2 fixed    &lt;NA&gt;   X_e                4.00        11.9     0.337  51.4  7.38e- 1
##  3 fixed    &lt;NA&gt;   X_c               79.5         24.1     3.30   77.0  1.48e- 3
##  4 fixed    &lt;NA&gt;   X_e:X_c           76.0         26.6     2.86   65.8  5.74e- 3
##  5 ran_pars item_â€¦ sd__(Intercept)   69.3         NA      NA      NA   NA       
##  6 ran_pars item_â€¦ cor__(Interceptâ€¦  -0.104       NA      NA      NA   NA       
##  7 ran_pars item_â€¦ sd__X_e           70.1         NA      NA      NA   NA       
##  8 ran_pars subj_â€¦ sd__(Intercept)  107.          NA      NA      NA   NA       
##  9 ran_pars subj_â€¦ cor__(Interceptâ€¦   0.199       NA      NA      NA   NA       
## 10 ran_pars subj_â€¦ cor__(Interceptâ€¦   0.259       NA      NA      NA   NA       
## 11 ran_pars subj_â€¦ cor__(Interceptâ€¦   0.0954      NA      NA      NA   NA       
## 12 ran_pars subj_â€¦ sd__X_e           24.0         NA      NA      NA   NA       
## 13 ran_pars subj_â€¦ cor__X_e.X_c      -0.0173      NA      NA      NA   NA       
## 14 ran_pars subj_â€¦ cor__X_e.X_e:X_c   0.191       NA      NA      NA   NA       
## 15 ran_pars subj_â€¦ sd__X_c           91.0         NA      NA      NA   NA       
## 16 ran_pars subj_â€¦ cor__X_c.X_e:X_c   0.106       NA      NA      NA   NA       
## 17 ran_pars subj_â€¦ sd__X_e:X_c       97.6         NA      NA      NA   NA       
## 18 ran_pars Residâ€¦ sd__Observation  197.          NA      NA      NA   NA</code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">end_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">end_time</span> <span class="op">-</span> <span class="va">start_time</span></code></pre></div>
<pre><code>## Time difference of 7.479683 secs</code></pre>
</div>
<div id="power-analysis" class="section level3">
<h3 class="hasAnchor">
<a href="#power-analysis" class="anchor"></a>Power Analysis</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">filename</span> <span class="op">&lt;-</span> <span class="st">"sims/ext_sims.csv"</span> <span class="co"># change for new analyses</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="va">filename</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># run simulations and save to a file</span>
  <span class="va">reps</span> <span class="op">&lt;-</span> <span class="fl">20</span>
  <span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_df</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">reps</span>, <span class="op">~</span><span class="fu">single_run</span><span class="op">(</span><span class="va">filename</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># read saved simulation data</span>
<span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="va">filename</span>, col_types <span class="op">=</span> <span class="fu">cols</span><span class="op">(</span>
  <span class="co"># makes sure plots display in this order</span>
  group <span class="op">=</span> <span class="fu">col_factor</span><span class="op">(</span>ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  term <span class="op">=</span> <span class="fu">col_factor</span><span class="op">(</span>ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">)</span><span class="op">)</span></code></pre></div>
<p>You can use these data to calculate power for each fixed effect or plot the distribution of your fixed or random effects.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># calculate mean estimates and power for specified alpha</span>
<span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">0.05</span>

<span class="va">sims</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">effect</span> <span class="op">==</span> <span class="st">"fixed"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">term</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>
    mean_estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span>,
    mean_se <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">std.error</span><span class="op">)</span>,
    power <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">p.value</span> <span class="op">&lt;</span> <span class="va">alpha</span><span class="op">)</span>,
    .groups <span class="op">=</span> <span class="st">"drop"</span>
  <span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 4 x 4
##   term        mean_estimate mean_se power
##   &lt;ord&gt;               &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;
## 1 (Intercept)        806.      18.5  1   
## 2 X_e                 -6.99    11.6  0.1 
## 3 X_c                 50.5     26.5  0.35
## 4 X_e:X_c             78.0     23.7  0.9</code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sim_stats</span> <span class="op">&lt;-</span> <span class="va">sims</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">effect</span> <span class="op">==</span> <span class="st">"fixed"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">term</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>
    value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span>,
    .groups <span class="op">=</span> <span class="st">"drop"</span>
  <span class="op">)</span>

<span class="va">sims</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">effect</span> <span class="op">==</span> <span class="st">"fixed"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">estimate</span>, y <span class="op">=</span> <span class="va">..count..</span>, fill <span class="op">=</span> <span class="va">term</span><span class="op">)</span>, 
               alpha <span class="op">=</span> <span class="fl">0.5</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span>data <span class="op">=</span> <span class="va">sim_stats</span>, <span class="fu">aes</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">value</span><span class="op">)</span>, 
             color <span class="op">=</span> <span class="st">"grey40"</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">term</span>, ncol <span class="op">=</span> <span class="fl">2</span>, scales <span class="op">=</span> <span class="st">"free_x"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="appendix2_extended_example_files/figure-html/unnamed-chunk-9-1.png" alt="Distribution of fixed effects across simulations" width="100%"><p class="caption">
Distribution of fixed effects across simulations
</p>
</div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sim_stats</span> <span class="op">&lt;-</span> <span class="va">sims</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">effect</span> <span class="op">==</span> <span class="st">"ran_pars"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">group</span>, <span class="va">term</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span>,
            .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span>

<span class="va">sims</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">effect</span> <span class="op">==</span> <span class="st">"ran_pars"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">estimate</span>, fill <span class="op">=</span> <span class="va">group</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span>data <span class="op">=</span> <span class="va">sim_stats</span>, <span class="fu">aes</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">value</span><span class="op">)</span>,
             show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">group</span><span class="op">*</span><span class="va">term</span>, ncol <span class="op">=</span> <span class="fl">3</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="appendix2_extended_example_files/figure-html/unnamed-chunk-10-1.png" alt="Distribution of random effects across simulations" width="100%"><p class="caption">
Distribution of random effects across simulations
</p>
</div>
</div>
</div>
<div id="ww2ww-design-with-counterbalancing" class="section level2">
<h2 class="hasAnchor">
<a href="#ww2ww-design-with-counterbalancing" class="anchor"></a>2ww2ww Design with Counterbalancing</h2>
<p>What if you change your design, and now category in a within-face factor, so each face can be either ingroup or outgroup. Subjects see each face only once in only one expression; whether a face is ingroup or outgroup, and happy or angry, is counterbalanced between subjects. Therefore, we need to change the data generating function a bit, although the rest of the code above doesnâ€™t need to change.</p>
<p>Since category is now a within-subject factor, we need to add random slopes for category and the category*expression interaction for subjects, plus all of their correlations. We will also be specifying the subject and item Ns a little differently, as number of subjects per each of the 4 counterbalanced versions, and number of items per each of 4 groupsused in the counterbalancing.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># data simulation for a design with a 2x2 design where </span>
<span class="co"># the first factor is within subjects and within items, </span>
<span class="co"># and the second factor is within subjects and within items</span>
<span class="co"># subjects see each face only once; whether a face is ingroup or outgraoup is counterbalanced between subjects</span>

<span class="va">sim_data_2ww2ww</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span>
  <span class="va">n_subj</span>     <span class="op">=</span>  <span class="fl">50</span>, <span class="co"># number of subjects in each counterbalance group</span>
  <span class="va">n_item</span>     <span class="op">=</span>  <span class="fl">25</span>, <span class="co"># number of items in each counterbalance group</span>
  <span class="va">beta_0</span>     <span class="op">=</span> <span class="fl">800</span>, <span class="co"># intercept (grand mean)</span>
  <span class="va">beta_e</span>     <span class="op">=</span>  <span class="fl">50</span>, <span class="co"># main effect of category</span>
  <span class="va">beta_c</span>     <span class="op">=</span>   <span class="fl">0</span>, <span class="co"># main effect of expression</span>
  <span class="va">beta_ec</span>    <span class="op">=</span>  <span class="fl">70</span>, <span class="co"># interaction between category and expression</span>
  <span class="va">subj_0</span>     <span class="op">=</span> <span class="fl">100</span>, <span class="co"># by-subject random intercept sd</span>
  <span class="va">subj_e</span>     <span class="op">=</span>  <span class="fl">40</span>, <span class="co"># by-subject random slope sd for exp</span>
  <span class="va">subj_c</span>     <span class="op">=</span>  <span class="fl">80</span>, <span class="co"># by-subject random slope sd for category</span>
  <span class="va">subj_ec</span>    <span class="op">=</span>  <span class="fl">80</span>, <span class="co"># by-subject random slope sd for category*exp</span>
  <span class="co"># by-subject random effect correlations</span>
  <span class="va">subj_rho</span>   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.3</span>, <span class="fl">.3</span>, <span class="fl">.3</span>,   <span class="co"># beta_0 * beta_c, beta_e, beta_ce</span>
                     <span class="fl">.1</span>, <span class="fl">.1</span>,   <span class="co"># beta_c *         beta_e, beta_ce</span>
                         <span class="fl">.1</span><span class="op">)</span>,  <span class="co"># beta_e *                 beta_ce</span>
  <span class="va">item_0</span>     <span class="op">=</span>  <span class="fl">80</span>, <span class="co"># by-item random intercept sd</span>
  <span class="va">item_e</span>     <span class="op">=</span>  <span class="fl">60</span>, <span class="co"># by-item random slope for exp</span>
  <span class="va">item_c</span>     <span class="op">=</span>  <span class="fl">70</span>, <span class="co"># by-item random slope sd for category</span>
  <span class="va">item_ec</span>    <span class="op">=</span>  <span class="fl">70</span>, <span class="co"># by-item random slope sd for category*exp</span>
  <span class="co"># by-item random effect correlations</span>
  <span class="va">item_rho</span>   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.2</span>, <span class="fl">.2</span>, <span class="fl">.2</span>,   <span class="co"># beta_0 * beta_c, beta_e, beta_ce</span>
                     <span class="fl">.1</span>, <span class="fl">.1</span>,   <span class="co"># beta_c *         beta_e, beta_ce</span>
                         <span class="fl">.1</span><span class="op">)</span>,  <span class="co"># beta_e *                 beta_ce</span>
  <span class="va">sigma</span>      <span class="op">=</span> <span class="fl">200</span>   <span class="co"># residual (error) sd</span>
<span class="op">)</span> <span class="op">{</span>

  <span class="co"># simulate items</span>
  <span class="va">items</span> <span class="op">&lt;-</span> <span class="fu">faux</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/faux/man/rnorm_multi.html">rnorm_multi</a></span><span class="op">(</span>
    n <span class="op">=</span> <span class="va">n_item</span> <span class="op">*</span> <span class="fl">4</span>,
    mu <span class="op">=</span> <span class="fl">0</span>, 
    sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">item_0</span>, <span class="va">item_e</span>, <span class="va">item_c</span>, <span class="va">item_ec</span><span class="op">)</span>,
    r <span class="op">=</span> <span class="va">item_rho</span>,
    varnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"I_0"</span>, <span class="st">"I_e"</span>, <span class="st">"I_c"</span>, <span class="st">"I_ec"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span>item_id <span class="op">=</span> <span class="fu">faux</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/faux/man/make_id.html">make_id</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="st">"I"</span><span class="op">)</span>,
           <span class="co"># faces are in 1 of 4 groups</span>
           grp_i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="va">n_item</span><span class="op">)</span><span class="op">)</span>

  <span class="co"># simulate subjects</span>
  <span class="va">subjects</span> <span class="op">&lt;-</span> <span class="fu">faux</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/faux/man/rnorm_multi.html">rnorm_multi</a></span><span class="op">(</span>
    n <span class="op">=</span> <span class="va">n_subj</span> <span class="op">*</span> <span class="fl">4</span>,
    mu <span class="op">=</span> <span class="fl">0</span>,
    sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">subj_0</span>, <span class="va">subj_e</span>, <span class="va">subj_c</span>, <span class="va">subj_ec</span><span class="op">)</span>, 
    r <span class="op">=</span> <span class="va">subj_rho</span>,
    varnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"S_0"</span>, <span class="st">"S_e"</span>, <span class="st">"S_c"</span>, <span class="st">"S_ec"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span>subj_id <span class="op">=</span> <span class="fu">faux</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/faux/man/make_id.html">make_id</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="st">"S"</span><span class="op">)</span>,
           <span class="co"># subjects view 1 of 4 counterbalanced versions</span>
           cb <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, <span class="va">n_subj</span><span class="op">)</span><span class="op">)</span>

  <span class="co"># simulate trials</span>
  <span class="va">all_trials</span> <span class="op">&lt;-</span> <span class="fu">crossing</span><span class="op">(</span><span class="va">subjects</span>, <span class="va">items</span>,
    expression <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"happy"</span>, <span class="st">"angry"</span><span class="op">)</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    category <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ingroup"</span>, <span class="st">"outgroup"</span><span class="op">)</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span>
  
  <span class="co"># keep only correct CB</span>
  <span class="co">#     A   B   C   D </span>
  <span class="co"># 1 = IH, IA, OH, OA</span>
  <span class="co"># 2 = IA, IH, OA, OH</span>
  <span class="co"># 3 = OH, OA, IH, IA</span>
  <span class="co"># 4 = OA, OH, IA, IH</span>
  <span class="va">trials</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">all_trials</span>,
    <span class="op">(</span><span class="va">cb</span> <span class="op">==</span> <span class="st">"A"</span> <span class="op">&amp;</span> <span class="va">grp_i</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">category</span> <span class="op">==</span> <span class="st">"ingroup"</span> <span class="op">&amp;</span> <span class="va">expression</span> <span class="op">==</span> <span class="st">"happy"</span><span class="op">)</span> <span class="op">|</span>
    <span class="op">(</span><span class="va">cb</span> <span class="op">==</span> <span class="st">"A"</span> <span class="op">&amp;</span> <span class="va">grp_i</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="va">category</span> <span class="op">==</span> <span class="st">"ingroup"</span> <span class="op">&amp;</span> <span class="va">expression</span> <span class="op">==</span> <span class="st">"angry"</span><span class="op">)</span> <span class="op">|</span>
    <span class="op">(</span><span class="va">cb</span> <span class="op">==</span> <span class="st">"A"</span> <span class="op">&amp;</span> <span class="va">grp_i</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">&amp;</span> <span class="va">category</span> <span class="op">==</span> <span class="st">"outgroup"</span> <span class="op">&amp;</span> <span class="va">expression</span> <span class="op">==</span> <span class="st">"happy"</span><span class="op">)</span> <span class="op">|</span>
    <span class="op">(</span><span class="va">cb</span> <span class="op">==</span> <span class="st">"A"</span> <span class="op">&amp;</span> <span class="va">grp_i</span> <span class="op">==</span> <span class="fl">4</span> <span class="op">&amp;</span> <span class="va">category</span> <span class="op">==</span> <span class="st">"outgroup"</span> <span class="op">&amp;</span> <span class="va">expression</span> <span class="op">==</span> <span class="st">"angry"</span><span class="op">)</span> <span class="op">|</span>
    <span class="op">(</span><span class="va">cb</span> <span class="op">==</span> <span class="st">"B"</span> <span class="op">&amp;</span> <span class="va">grp_i</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="va">category</span> <span class="op">==</span> <span class="st">"ingroup"</span> <span class="op">&amp;</span> <span class="va">expression</span> <span class="op">==</span> <span class="st">"happy"</span><span class="op">)</span> <span class="op">|</span>
    <span class="op">(</span><span class="va">cb</span> <span class="op">==</span> <span class="st">"B"</span> <span class="op">&amp;</span> <span class="va">grp_i</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">category</span> <span class="op">==</span> <span class="st">"ingroup"</span> <span class="op">&amp;</span> <span class="va">expression</span> <span class="op">==</span> <span class="st">"angry"</span><span class="op">)</span> <span class="op">|</span>
    <span class="op">(</span><span class="va">cb</span> <span class="op">==</span> <span class="st">"B"</span> <span class="op">&amp;</span> <span class="va">grp_i</span> <span class="op">==</span> <span class="fl">4</span> <span class="op">&amp;</span> <span class="va">category</span> <span class="op">==</span> <span class="st">"outgroup"</span> <span class="op">&amp;</span> <span class="va">expression</span> <span class="op">==</span> <span class="st">"happy"</span><span class="op">)</span> <span class="op">|</span>
    <span class="op">(</span><span class="va">cb</span> <span class="op">==</span> <span class="st">"B"</span> <span class="op">&amp;</span> <span class="va">grp_i</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">&amp;</span> <span class="va">category</span> <span class="op">==</span> <span class="st">"outgroup"</span> <span class="op">&amp;</span> <span class="va">expression</span> <span class="op">==</span> <span class="st">"angry"</span><span class="op">)</span> <span class="op">|</span>
    <span class="op">(</span><span class="va">cb</span> <span class="op">==</span> <span class="st">"C"</span> <span class="op">&amp;</span> <span class="va">grp_i</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">&amp;</span> <span class="va">category</span> <span class="op">==</span> <span class="st">"ingroup"</span> <span class="op">&amp;</span> <span class="va">expression</span> <span class="op">==</span> <span class="st">"happy"</span><span class="op">)</span> <span class="op">|</span>
    <span class="op">(</span><span class="va">cb</span> <span class="op">==</span> <span class="st">"C"</span> <span class="op">&amp;</span> <span class="va">grp_i</span> <span class="op">==</span> <span class="fl">4</span> <span class="op">&amp;</span> <span class="va">category</span> <span class="op">==</span> <span class="st">"ingroup"</span> <span class="op">&amp;</span> <span class="va">expression</span> <span class="op">==</span> <span class="st">"angry"</span><span class="op">)</span> <span class="op">|</span>
    <span class="op">(</span><span class="va">cb</span> <span class="op">==</span> <span class="st">"C"</span> <span class="op">&amp;</span> <span class="va">grp_i</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">category</span> <span class="op">==</span> <span class="st">"outgroup"</span> <span class="op">&amp;</span> <span class="va">expression</span> <span class="op">==</span> <span class="st">"happy"</span><span class="op">)</span> <span class="op">|</span>
    <span class="op">(</span><span class="va">cb</span> <span class="op">==</span> <span class="st">"C"</span> <span class="op">&amp;</span> <span class="va">grp_i</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="va">category</span> <span class="op">==</span> <span class="st">"outgroup"</span> <span class="op">&amp;</span> <span class="va">expression</span> <span class="op">==</span> <span class="st">"angry"</span><span class="op">)</span> <span class="op">|</span>
    <span class="op">(</span><span class="va">cb</span> <span class="op">==</span> <span class="st">"D"</span> <span class="op">&amp;</span> <span class="va">grp_i</span> <span class="op">==</span> <span class="fl">4</span> <span class="op">&amp;</span> <span class="va">category</span> <span class="op">==</span> <span class="st">"ingroup"</span> <span class="op">&amp;</span> <span class="va">expression</span> <span class="op">==</span> <span class="st">"happy"</span><span class="op">)</span> <span class="op">|</span>
    <span class="op">(</span><span class="va">cb</span> <span class="op">==</span> <span class="st">"D"</span> <span class="op">&amp;</span> <span class="va">grp_i</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">&amp;</span> <span class="va">category</span> <span class="op">==</span> <span class="st">"ingroup"</span> <span class="op">&amp;</span> <span class="va">expression</span> <span class="op">==</span> <span class="st">"angry"</span><span class="op">)</span> <span class="op">|</span>
    <span class="op">(</span><span class="va">cb</span> <span class="op">==</span> <span class="st">"D"</span> <span class="op">&amp;</span> <span class="va">grp_i</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="va">category</span> <span class="op">==</span> <span class="st">"outgroup"</span> <span class="op">&amp;</span> <span class="va">expression</span> <span class="op">==</span> <span class="st">"happy"</span><span class="op">)</span> <span class="op">|</span>
    <span class="op">(</span><span class="va">cb</span> <span class="op">==</span> <span class="st">"D"</span> <span class="op">&amp;</span> <span class="va">grp_i</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">category</span> <span class="op">==</span> <span class="st">"outgroup"</span> <span class="op">&amp;</span> <span class="va">expression</span> <span class="op">==</span> <span class="st">"angry"</span><span class="op">)</span><span class="op">)</span>
  
  <span class="va">trials</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span> 
      <span class="co"># effect code the two fixed factors</span>
      X_e <span class="op">=</span> <span class="fu">recode</span><span class="op">(</span><span class="va">expression</span>, <span class="st">"happy"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">0.5</span>, <span class="st">"angry"</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,
      X_c <span class="op">=</span> <span class="fu">recode</span><span class="op">(</span><span class="va">category</span>, <span class="st">"ingroup"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">0.5</span>, <span class="st">"outgroup"</span> <span class="op">=</span> <span class="op">+</span><span class="fl">0.5</span><span class="op">)</span>,
      <span class="co"># add together fixed and random effects for each effect</span>
      B_0  <span class="op">=</span> <span class="va">beta_0</span>  <span class="op">+</span> <span class="va">S_0</span>  <span class="op">+</span> <span class="va">I_0</span>,
      B_e  <span class="op">=</span> <span class="va">beta_c</span>  <span class="op">+</span> <span class="va">S_e</span>  <span class="op">+</span> <span class="va">I_e</span>,
      B_c  <span class="op">=</span> <span class="va">beta_e</span>  <span class="op">+</span> <span class="va">S_c</span>  <span class="op">+</span> <span class="va">I_c</span>,
      B_ec <span class="op">=</span> <span class="va">beta_ec</span> <span class="op">+</span> <span class="va">S_ec</span> <span class="op">+</span> <span class="va">I_ec</span>,
      <span class="co"># generate the error term</span>
      e_si <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span>,
      <span class="co"># calculate RT by adding each effect term </span>
      <span class="co"># multiplied by the relevant effect-coded factor(s)</span>
      RT <span class="op">=</span> <span class="va">B_0</span> <span class="op">+</span> <span class="op">(</span><span class="va">B_e</span><span class="op">*</span><span class="va">X_e</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">B_c</span><span class="op">*</span><span class="va">X_c</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">B_ec</span><span class="op">*</span><span class="va">X_e</span><span class="op">*</span><span class="va">X_c</span><span class="op">)</span> <span class="op">+</span> <span class="va">e_si</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">select</span><span class="op">(</span><span class="va">subj_id</span>, <span class="va">item_id</span>, <span class="va">cb</span>, <span class="va">expression</span>, <span class="va">category</span>, <span class="va">X_e</span>, <span class="va">X_c</span>, <span class="va">RT</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>This is really tricky, so test your data thoroughly:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat_sim</span> <span class="op">&lt;-</span> <span class="fu">sim_data_2ww2ww</span><span class="op">(</span><span class="op">)</span>

<span class="fu">group_by</span><span class="op">(</span><span class="va">dat_sim</span>, <span class="va">cb</span>, <span class="va">expression</span>, <span class="va">category</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>n_subj <span class="op">=</span> <span class="fu">n_distinct</span><span class="op">(</span><span class="va">subj_id</span><span class="op">)</span>,
            n_item <span class="op">=</span> <span class="fu">n_distinct</span><span class="op">(</span><span class="va">item_id</span><span class="op">)</span>,
            mean_RT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">RT</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 16 x 6
## # Groups:   cb, expression [8]
##    cb    expression category n_subj n_item mean_RT
##    &lt;chr&gt; &lt;ord&gt;      &lt;ord&gt;     &lt;int&gt;  &lt;int&gt;   &lt;dbl&gt;
##  1 A     angry      ingroup      50     25    750.
##  2 A     angry      outgroup     50     25    860.
##  3 A     happy      ingroup      50     25    764.
##  4 A     happy      outgroup     50     25    796.
##  5 B     angry      ingroup      50     25    726.
##  6 B     angry      outgroup     50     25    870.
##  7 B     happy      ingroup      50     25    805.
##  8 B     happy      outgroup     50     25    831.
##  9 C     angry      ingroup      50     25    801.
## 10 C     angry      outgroup     50     25    841.
## 11 C     happy      ingroup      50     25    799.
## 12 C     happy      outgroup     50     25    801.
## 13 D     angry      ingroup      50     25    782.
## 14 D     angry      outgroup     50     25    846.
## 15 D     happy      ingroup      50     25    841.
## 16 D     happy      outgroup     50     25    799.</code></pre>
<div id="analyse-data-1" class="section level3">
<h3 class="hasAnchor">
<a href="#analyse-data-1" class="anchor"></a>Analyse Data</h3>
<p>The power function is similar to above, with a different data generating function and a different formula in the model.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># set up the power function</span>
<span class="va">single_run2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">filename</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">dat_sim</span> <span class="op">&lt;-</span> <span class="fu">sim_data_2ww2ww</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="co"># change to 2ww2ww version</span>
  
  <span class="va">mod_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">RT</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">X_e</span><span class="op">*</span><span class="va">X_c</span> <span class="op">+</span> 
                    <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">X_e</span><span class="op">*</span><span class="va">X_c</span> <span class="op">|</span> <span class="va">item_id</span><span class="op">)</span> <span class="op">+</span> <span class="co"># add X_c here now it's w/in items</span>
                    <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">X_e</span><span class="op">*</span><span class="va">X_c</span> <span class="op">|</span> <span class="va">subj_id</span><span class="op">)</span>,
                  data <span class="op">=</span> <span class="va">dat_sim</span><span class="op">)</span>
  
  <span class="va">sim_results</span> <span class="op">&lt;-</span> <span class="fu">broom.mixed</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">mod_sim</span><span class="op">)</span>
  
  <span class="co"># append the results to a file if filename is set</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">filename</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">append</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="va">filename</span><span class="op">)</span> <span class="co"># append if the file exists</span>
    <span class="fu">write_csv</span><span class="op">(</span><span class="va">sim_results</span>, <span class="va">filename</span>, append <span class="op">=</span> <span class="va">append</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="co"># return the tidy table</span>
  <span class="va">sim_results</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="power-analysis-1" class="section level3">
<h3 class="hasAnchor">
<a href="#power-analysis-1" class="anchor"></a>Power Analysis</h3>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">filename</span> <span class="op">&lt;-</span> <span class="st">"sims/ext_sims_2.csv"</span> <span class="co"># change for new analyses</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="va">filename</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># run simulations and save to a file</span>
  <span class="va">reps</span> <span class="op">&lt;-</span> <span class="fl">20</span>
  <span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_df</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">reps</span>, <span class="op">~</span><span class="fu">single_run2</span><span class="op">(</span><span class="va">filename</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># read saved simulation data</span>
<span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="va">filename</span>, col_types <span class="op">=</span> <span class="fu">cols</span><span class="op">(</span>
  <span class="co"># makes sure plots display in this order</span>
  group <span class="op">=</span> <span class="fu">col_factor</span><span class="op">(</span>ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  term <span class="op">=</span> <span class="fu">col_factor</span><span class="op">(</span>ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Lisa DeBruine, Dale Barr.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
