<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Appendix 3: Binomial Example • lmem.sim</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Appendix 3: Binomial Example">
<meta property="og:description" content="lmem.sim">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">lmem.sim</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/appendix1_example_code.html">Appendix 1: Example Code</a>
    </li>
    <li>
      <a href="../articles/appendix1b_example_code.html">Appendix 1b: Example Code (no tidyverse)</a>
    </li>
    <li>
      <a href="../articles/appendix1c_sensitivity.html">Appendix 1c: Sensitivity Analysis</a>
    </li>
    <li>
      <a href="../articles/appendix2_extended_example.html">Appendix 2: Extended Example</a>
    </li>
    <li>
      <a href="../articles/appendix3_binomial.html">Appendix 3: Binomial Example</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="appendix3_binomial_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Appendix 3: Binomial Example</h1>
            <h3 class="subtitle">Understanding mixed effects models through data simulation</h3>
                        <h4 class="author">Lisa M. DeBruine &amp; Dale J. Barr</h4>
            
      
      
      <div class="hidden name"><code>appendix3_binomial.Rmd</code></div>

    </div>

    
    
<div id="simulating-binomial-data-with-crossed-random-factors" class="section level2">
<h2 class="hasAnchor">
<a href="#simulating-binomial-data-with-crossed-random-factors" class="anchor"></a>Simulating binomial data with crossed random factors</h2>
<p>To give an overview of the simulation task, we will simulate data from a design with crossed random factors of subjects and stimuli, fit a model to the simulated data, and then try to recover the parameter values we put in from the output. In this hypothetical study, subjects classify the emotional expressions of faces as quickly as possible, and we use accuracy (correct/incorrect) as the primary dependent variable. The faces are of two types: either from the subject’s ingroup or from an outgroup. For simplicity, we further assume that each face appears only once in the stimulus set. The key question is whether there is any difference in classification accuracy across the type of face.</p>
<p>The important parts of the design are:</p>
<ul>
<li>Random factor 1: subjects (associated variables will be prefixed by T, <span class="math inline">\(\tau\)</span>, or <code>tau</code>)</li>
<li>Random factor 2: faces (associated variables will be prefixed by O, <span class="math inline">\(\omega\)</span>, or <code>omega</code>)</li>
<li>Fixed factor 1: category (level = ingroup, outgroup)
<ul>
<li>within subject: subjects see both ingroup and outgroup faces</li>
<li>between face: faces are either ingroup or outgroup</li>
</ul>
</li>
</ul>
<div id="required-software" class="section level3">
<h3 class="hasAnchor">
<a href="#required-software" class="anchor"></a>Required software</h3>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="co"># load required packages</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"lme4"</span>)        <span class="co"># model specification / estimation</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"afex"</span>)        <span class="co"># anova and deriving p-values from lmer</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"broom.mixed"</span>) <span class="co"># extracting data from model fits </span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"faux"</span>)        <span class="co"># data simulation</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"tidyverse"</span>)   <span class="co"># data wrangling and visualisation</span>

<span class="co"># ensure this script returns the same results on each run</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">8675309</span>)
<span class="fu"><a href="https://rdrr.io/pkg/faux/man/faux_options.html">faux_options</a></span>(<span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>)</pre></body></html></div>
<p>This example presents a simulation for a binomial logistic mixed regression. Part of the process involves conversion between probability and the logit function of probability. The code below converts between these.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">logit</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) { <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="no">x</span> / (<span class="fl">1</span> - <span class="no">x</span>)) }
<span class="no">inv_logit</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) { <span class="fl">1</span> / (<span class="fl">1</span> + <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(-<span class="no">x</span>)) }

<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">prob</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">.01</span>)
) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">logit</span> <span class="kw">=</span> <span class="fu">logit</span>(<span class="no">prob</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="no">prob</span>, <span class="no">logit</span>)) +
  <span class="fu">geom_point</span>()</pre></body></html></div>
<p><img src="appendix3_binomial_files/figure-html/unnamed-chunk-2-1.png" width="100%"></p>
</div>
<div id="data-simulation-function" class="section level3">
<h3 class="hasAnchor">
<a href="#data-simulation-function" class="anchor"></a>Data simulation function</h3>
<p>The data generating process is slighly different for binomial logistic regression. The random effects and their correlations are set the same way as for a gaussian model (you’ll need some pilot data to estimate reasonable parameters), but we don’t need an error term.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="co"># set up the custom data simulation function</span>
<span class="no">my_bin_data</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(
  <span class="no">tau_n</span>  <span class="kw">=</span> <span class="fl">100</span>, <span class="co"># number of subjects</span>
  <span class="no">omega_n</span>  <span class="kw">=</span> <span class="fl">50</span>,  <span class="co"># number of items per category</span>
  <span class="no">b0</span>     <span class="kw">=</span> <span class="fl">0</span>, <span class="co"># intercept</span>
  <span class="no">b1</span>     <span class="kw">=</span> <span class="fl">0</span>, <span class="co"># effect of category</span>
  <span class="no">omega_0</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="co"># by-item random intercept sd</span>
  <span class="no">tau_0</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="co"># by-subject random intercept sd</span>
  <span class="no">tau_1</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="co"># by-subject random slope sd</span>
  <span class="no">tau_r</span>   <span class="kw">=</span> <span class="fl">0</span> <span class="co"># correlation between intercept and slope</span>
                        ) {
   <span class="co"># simulate a sample of items</span>
  <span class="no">items</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
    <span class="kw">item_id</span> <span class="kw">=</span> <span class="fl">1</span>:(<span class="no">omega_n</span>*<span class="fl">2</span>),
    <span class="kw">category</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"ingroup"</span>, <span class="st">"outgroup"</span>), <span class="no">omega_n</span>),
    <span class="kw">O0i</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="no">omega_n</span>*<span class="fl">2</span>, <span class="fl">0</span>, <span class="no">omega_0</span>)
  )

  <span class="co"># effect code category</span>
  <span class="no">items</span>$<span class="no">cat</span> <span class="kw">&lt;-</span> <span class="fu">recode</span>(<span class="no">items</span>$<span class="no">category</span>,
                      <span class="st">"ingroup"</span> <span class="kw">=</span> -<span class="fl">0.5</span>,
                      <span class="st">"outgroup"</span> <span class="kw">=</span> <span class="fl">0.5</span>)

  <span class="co"># simulate a sample of subjects</span>
  <span class="no">subjects</span> <span class="kw">&lt;-</span> <span class="kw pkg">faux</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/faux/man/rnorm_multi.html">rnorm_multi</a></span>(
    <span class="kw">n</span> <span class="kw">=</span> <span class="no">tau_n</span>,
    <span class="kw">mu</span> <span class="kw">=</span> <span class="fl">0</span>,
    <span class="kw">sd</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">tau_0</span>, <span class="no">tau_1</span>),
    <span class="kw">r</span> <span class="kw">=</span> <span class="no">tau_r</span>,
    <span class="kw">varnames</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"T0s"</span>, <span class="st">"T1s"</span>)
  )
  <span class="no">subjects</span>$<span class="no">subj_id</span> <span class="kw">&lt;-</span> <span class="fl">1</span>:<span class="no">tau_n</span>

  <span class="co"># simulate trials</span>
  <span class="no">dat_sim</span> <span class="kw">&lt;-</span> <span class="fu">crossing</span>(<span class="kw">subj_id</span> <span class="kw">=</span> <span class="no">subjects</span>$<span class="no">subj_id</span>,
                      <span class="kw">item_id</span> <span class="kw">=</span> <span class="no">items</span>$<span class="no">item_id</span>) <span class="kw">%&gt;%</span>
    <span class="fu">inner_join</span>(<span class="no">subjects</span>, <span class="st">"subj_id"</span>) <span class="kw">%&gt;%</span>
    <span class="fu">inner_join</span>(<span class="no">items</span>, <span class="st">"item_id"</span>) <span class="kw">%&gt;%</span>
    <span class="fu">mutate</span>(<span class="kw">Y</span> <span class="kw">=</span> <span class="no">b0</span> + <span class="no">I0i</span> + <span class="no">S0s</span> + (<span class="no">b1</span> + <span class="no">S1s</span>) * <span class="no">cat</span>, <span class="co"># calculate gaussian DV</span>
           <span class="kw">pr</span> <span class="kw">=</span> <span class="fu">inv_logit</span>(<span class="no">Y</span>), <span class="co"># transform to probability of getting 1</span>
           <span class="kw">Y_bin</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">.</span>), <span class="fl">1</span>, <span class="no">pr</span>)) <span class="kw">%&gt;%</span> <span class="co"># sample from bernoulli distribution </span>
  <span class="fu">select</span>(<span class="no">subj_id</span>, <span class="no">item_id</span>, <span class="no">category</span>, <span class="no">cat</span>, <span class="no">Y</span>, <span class="no">Y_bin</span>)

  <span class="no">dat_sim</span>
}

<span class="co"># set up the power function</span>
<span class="no">my_glmer_power</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">...</span>) {
  <span class="co"># ... is a shortcut that forwards any arguments to my_sim_data()</span>
  <span class="no">dat_sim</span> <span class="kw">&lt;-</span> <span class="fu">my_bin_data</span>(<span class="no">...</span>)
  <span class="no">mod_sim</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer</a></span>(<span class="no">Y_bin</span> ~ <span class="fl">1</span> + <span class="no">cat</span> + (<span class="fl">1</span> <span class="kw">|</span> <span class="no">item_id</span>) + (<span class="fl">1</span> + <span class="no">cat</span> <span class="kw">|</span> <span class="no">subj_id</span>),
                <span class="kw">data</span> <span class="kw">=</span> <span class="no">dat_sim</span>, <span class="kw">family</span> <span class="kw">=</span> <span class="st">"binomial"</span>)

  <span class="kw pkg">broom.mixed</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/broom.mixed/man/reexports.html">tidy</a></span>(<span class="no">mod_sim</span>)
}</pre></body></html></div>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="co"># run simulations</span>

<span class="no">prob2param</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">a</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="no">b</span> <span class="kw">=</span> <span class="fl">0</span>) {
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    <span class="kw">b0</span> <span class="kw">=</span> (<span class="fu">logit</span>(<span class="no">a</span>) + <span class="fu">logit</span>(<span class="no">b</span>))/<span class="fl">2</span>,
    <span class="kw">b1</span> <span class="kw">=</span> <span class="fu">logit</span>(<span class="no">a</span>) - <span class="fu">logit</span>(<span class="no">b</span>)
  )
}

<span class="no">reps</span> <span class="kw">&lt;-</span> <span class="fl">5</span>
<span class="no">b</span> <span class="kw">=</span> <span class="fu">prob2param</span>(<span class="fl">.4</span>, <span class="fl">.6</span>)
<span class="no">tau_0</span> <span class="kw">=</span> <span class="fl">1</span>
<span class="no">tau_1</span> <span class="kw">=</span> <span class="fl">1</span>
<span class="no">omega_0</span> <span class="kw">=</span> <span class="fl">1</span>
<span class="no">tau_r</span> <span class="kw">=</span> <span class="fl">0.5</span>

<span class="no">filename</span> <span class="kw">&lt;-</span> <span class="st">"sims/binomial.csv"</span></pre></body></html></div>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="co"># run simulations and save to a file on each rep</span>
<span class="no">sims</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span>(<span class="no">reps</span>, {
  <span class="no">sim</span> <span class="kw">&lt;-</span> <span class="fu">my_glmer_power</span>(<span class="kw">b0</span> <span class="kw">=</span> <span class="no">b</span>$<span class="no">b0</span>,
                       <span class="kw">b1</span> <span class="kw">=</span> <span class="no">b</span>$<span class="no">b1</span>,
                       <span class="kw">tau_0</span> <span class="kw">=</span> <span class="no">tau_0</span>,
                       <span class="kw">tau_1</span> <span class="kw">=</span> <span class="no">tau_1</span>,
                       <span class="kw">omega_0</span> <span class="kw">=</span> <span class="no">omega_0</span>,
                       <span class="kw">tau_r</span> <span class="kw">=</span> <span class="no">tau_r</span>)
  <span class="co"># check if there are already simulations </span>
  <span class="co"># saved to file and add them</span>
  <span class="no">append</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span>(<span class="no">filename</span>)
  <span class="fu">write_csv</span>(<span class="no">sim</span>, <span class="no">filename</span>, <span class="kw">append</span> <span class="kw">=</span> <span class="no">append</span>)
})</pre></body></html></div>
<p>The chunk above is set to not evaluate when you knit this file; it just reads the saved data from the file. The code below calculates the mean estimates and power for each group.</p>
</div>
<div id="calculate-mean-estimates-and-cell-probabilities" class="section level3">
<h3 class="hasAnchor">
<a href="#calculate-mean-estimates-and-cell-probabilities" class="anchor"></a>Calculate mean estimates and cell probabilities</h3>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="co"># read saved simulation data</span>
<span class="no">sims</span> <span class="kw">&lt;-</span> <span class="fu">read_csv</span>(<span class="no">filename</span>)

<span class="no">est</span> <span class="kw">&lt;-</span> <span class="no">sims</span> <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">group</span>, <span class="no">term</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise</span>(
    <span class="kw">mean_estimate</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">estimate</span>),
    <span class="kw">.groups</span> <span class="kw">=</span> <span class="st">"drop"</span>
  )

<span class="no">int_est</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">est</span>, <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">group</span>), <span class="no">term</span> <span class="kw">==</span> <span class="st">"(Intercept)"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pull</span>(<span class="no">mean_estimate</span>)
<span class="no">cat_est</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">est</span>, <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">group</span>), <span class="no">term</span> <span class="kw">==</span> <span class="st">"cat"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pull</span>(<span class="no">mean_estimate</span>)

<span class="no">pr0</span> <span class="kw">&lt;-</span> <span class="fu">inv_logit</span>(<span class="no">int_est</span>) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fl">2</span>)
<span class="no">pr1_plus</span> <span class="kw">&lt;-</span> <span class="fu">inv_logit</span>(<span class="no">int_est</span> + <span class="fl">.5</span>*<span class="no">cat_est</span>) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fl">2</span>)
<span class="no">pr1_minus</span> <span class="kw">&lt;-</span> <span class="fu">inv_logit</span>(<span class="no">int_est</span> - <span class="fl">.5</span>*<span class="no">cat_est</span>) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fl">2</span>)

<span class="no">est</span> <span class="kw">%&gt;%</span>
  <span class="fu">arrange</span>(!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">group</span>), <span class="no">group</span>, <span class="no">term</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(
  <span class="kw">sim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">b</span>$<span class="no">b0</span>, <span class="no">b</span>$<span class="no">b1</span>, <span class="no">omega_0</span>, <span class="no">tau_r</span>, <span class="no">tau_0</span>, <span class="no">tau_1</span>),
  <span class="kw">prob</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">pr0</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">pr1_minus</span>, <span class="st">":"</span>, <span class="no">pr1_plus</span>), <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>, <span class="fl">4</span>))
) <span class="kw">%&gt;%</span>
  <span class="fu">mutate_if</span>(<span class="no">is.numeric</span>, <span class="no">round</span>, <span class="fl">2</span>)</pre></body></html></div>
<pre><code>## # A tibble: 6 x 5
##   group   term                 mean_estimate   sim prob     
##   &lt;chr&gt;   &lt;chr&gt;                        &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;    
## 1 &lt;NA&gt;    (Intercept)                   0.03  0    0.51     
## 2 &lt;NA&gt;    cat                          -0.96 -0.81 0.63:0.39
## 3 item_id sd__(Intercept)               0.98  1    &lt;NA&gt;     
## 4 subj_id cor__(Intercept).cat          0.51  0.5  &lt;NA&gt;     
## 5 subj_id sd__(Intercept)               1     1    &lt;NA&gt;     
## 6 subj_id sd__cat                       0.95  1    &lt;NA&gt;</code></pre>
</div>
</div>
<div id="ww2wb-design" class="section level2">
<h2 class="hasAnchor">
<a href="#ww2wb-design" class="anchor"></a>2ww*2wb design</h2>
<p>In this example, 100 subjects will respond twice (for happy and angry expressions) to 50 items; 25 items in each of 2 categories. In this example, <code>expression</code> is a within-subject and within-item factor and <code>category</code> is a within-subject and between-item factor.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">ext_bin_data</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(
  <span class="no">tau_n</span>        <span class="kw">=</span> <span class="fl">100</span>, <span class="co"># number of subjects/btwn-grp</span>
  <span class="no">omega_n</span>        <span class="kw">=</span>  <span class="fl">25</span>, <span class="co"># number of items/btwn-grp</span>
  <span class="no">b0</span>           <span class="kw">=</span>   <span class="fl">0</span>, <span class="co"># grand mean</span>
  <span class="no">b_cat</span>        <span class="kw">=</span>   <span class="fl">0</span>, <span class="co"># main effect of category</span>
  <span class="no">b_exp</span>        <span class="kw">=</span>   <span class="fl">0</span>, <span class="co"># main effect of expression</span>
  <span class="no">b_cat_exp</span>    <span class="kw">=</span>   <span class="fl">0</span>, <span class="co"># interaction between category and expression</span>
  <span class="no">omega_0</span>       <span class="kw">=</span>   <span class="fl">1</span>, <span class="co"># by-item random intercept sd</span>
  <span class="no">Iexp_sd</span>      <span class="kw">=</span>   <span class="fl">1</span>, <span class="co"># by-item random slope for exp</span>
  <span class="no">icor</span>         <span class="kw">=</span>   <span class="fl">0</span>, <span class="co"># by-item random effect correlation</span>
  <span class="no">tau_0</span>       <span class="kw">=</span>   <span class="fl">1</span>, <span class="co"># by-subject random intercept sd</span>
  <span class="no">Scat_sd</span>      <span class="kw">=</span>   <span class="fl">1</span>, <span class="co"># by-subject random slope sd for category</span>
  <span class="no">Sexp_sd</span>      <span class="kw">=</span>   <span class="fl">1</span>, <span class="co"># by-subject random slope sd for exp</span>
  <span class="no">Scat_exp_sd</span>  <span class="kw">=</span>   <span class="fl">1</span>, <span class="co"># by-subject random slope sd for category*exp</span>
  <span class="co"># by-subject random effect correlations</span>
  <span class="no">tau_r</span>         <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>,   <span class="co"># S0s  * cat, exp, tc</span>
                      <span class="fl">0</span>, <span class="fl">0</span>,   <span class="co"># cat  *      exp, tc</span>
                         <span class="fl">0</span>)   <span class="co"># exp  *           tc</span>
) {

  <span class="co"># simulate items</span>
  <span class="no">items</span> <span class="kw">&lt;-</span> <span class="kw pkg">faux</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/faux/man/sim_design.html">sim_design</a></span>(
    <span class="kw">within</span>  <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">components</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"I0i"</span>, <span class="st">"Iexp"</span>)),
    <span class="kw">between</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">category</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"ingroup"</span>, <span class="st">"outgroup"</span>)),
    <span class="kw">n</span> <span class="kw">=</span> <span class="no">omega_n</span>,
    <span class="kw">sd</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">I0i</span> <span class="kw">=</span> <span class="no">omega_0</span>,
                    <span class="kw">Iexp</span> <span class="kw">=</span> <span class="no">Iexp_sd</span>),
    <span class="kw">r</span> <span class="kw">=</span> <span class="no">icor</span>,
    <span class="kw">id</span> <span class="kw">=</span> <span class="st">"item_id"</span>,
    <span class="kw">plot</span> <span class="kw">=</span> <span class="fl">FALSE</span>
  )

  <span class="co"># simulate subjects</span>
  <span class="no">subjects</span> <span class="kw">&lt;-</span> <span class="kw pkg">faux</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/faux/man/sim_design.html">sim_design</a></span>(
    <span class="kw">within</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">components</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"S0s"</span>, <span class="st">"Scat"</span>, <span class="st">"Sexp"</span>, <span class="st">"Scat_exp"</span>)),
    <span class="kw">n</span> <span class="kw">=</span> <span class="no">tau_n</span>,
    <span class="kw">sd</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">S0s</span>  <span class="kw">=</span> <span class="no">tau_0</span>,
           <span class="kw">Scat</span> <span class="kw">=</span> <span class="no">Scat_sd</span>,
           <span class="kw">Sexp</span> <span class="kw">=</span> <span class="no">Sexp_sd</span>,
           <span class="kw">Scat.exp</span>  <span class="kw">=</span> <span class="no">Scat_exp_sd</span>),
    <span class="kw">r</span> <span class="kw">=</span> <span class="no">tau_r</span>,
    <span class="kw">id</span> <span class="kw">=</span> <span class="st">"subj_id"</span>,
    <span class="kw">plot</span> <span class="kw">=</span> <span class="fl">FALSE</span>
  )

  <span class="co"># simulate trials</span>
  <span class="no">dat_sim</span> <span class="kw">&lt;-</span> <span class="fu">crossing</span>(
    <span class="kw">subj_id</span> <span class="kw">=</span> <span class="no">subjects</span>$<span class="no">subj_id</span>,
    <span class="kw">item_id</span> <span class="kw">=</span> <span class="no">items</span>$<span class="no">item_id</span>,
    <span class="kw">expression</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"happy"</span>, <span class="st">"angry"</span>), <span class="kw">ordered</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
  ) <span class="kw">%&gt;%</span>
    <span class="fu">inner_join</span>(<span class="no">subjects</span>, <span class="st">"subj_id"</span>) <span class="kw">%&gt;%</span>
    <span class="fu">inner_join</span>(<span class="no">items</span>, <span class="st">"item_id"</span>) <span class="kw">%&gt;%</span>
    <span class="fu">mutate</span>(<span class="kw">exp</span> <span class="kw">=</span> <span class="fu">recode</span>(<span class="no">expression</span>, <span class="st">"happy"</span> <span class="kw">=</span> -<span class="fl">0.5</span>, <span class="st">"angry"</span> <span class="kw">=</span> <span class="fl">0.5</span>),
           <span class="kw">cat</span> <span class="kw">=</span> <span class="fu">recode</span>(<span class="no">category</span>, <span class="st">"ingroup"</span> <span class="kw">=</span> -<span class="fl">0.5</span>, <span class="st">"outgroup"</span> <span class="kw">=</span> +<span class="fl">0.5</span>),
           <span class="kw">trial_i</span>    <span class="kw">=</span> <span class="no">b0</span> + <span class="no">I0i</span> +  <span class="no">S0s</span>,
           <span class="kw">trial_cat</span>  <span class="kw">=</span> <span class="no">b_cat</span> + <span class="no">Scat</span>,
           <span class="kw">trial_exp</span>  <span class="kw">=</span> <span class="no">b_exp</span> + <span class="no">Iexp</span> + <span class="no">Sexp</span>,
           <span class="kw">trial_ct</span>   <span class="kw">=</span> <span class="no">b_cat_exp</span> + <span class="no">Scat.exp</span>,
           <span class="kw">Y</span> <span class="kw">=</span> <span class="no">trial_i</span> +
             (<span class="no">trial_cat</span>*<span class="no">cat</span>) +
             (<span class="no">trial_exp</span>*<span class="no">exp</span>) +
             (<span class="no">trial_ct</span>*<span class="no">cat</span>*<span class="no">exp</span>),
           <span class="kw">pr</span> <span class="kw">=</span> <span class="fu">inv_logit</span>(<span class="no">Y</span>),
           <span class="kw">Y_bin</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">.</span>), <span class="fl">1</span>, <span class="no">pr</span>))

  <span class="no">dat_sim</span>
}

<span class="no">ext_bin_func</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">...</span>) {

  <span class="no">dat_sim</span> <span class="kw">&lt;-</span> <span class="fu">ext_bin_data</span>(<span class="no">...</span>)

  <span class="no">mod_sim</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer</a></span>(<span class="no">Y_bin</span> ~ <span class="fl">1</span> + <span class="no">cat</span>*<span class="no">exp</span> +
                    (<span class="fl">1</span> + <span class="no">exp</span> <span class="kw">|</span> <span class="no">item_id</span>) +
                    (<span class="fl">1</span> + <span class="no">cat</span>*<span class="no">exp</span> <span class="kw">|</span> <span class="no">subj_id</span>),
                  <span class="kw">data</span> <span class="kw">=</span> <span class="no">dat_sim</span>, <span class="kw">family</span> <span class="kw">=</span> <span class="st">"binomial"</span>)

  <span class="kw pkg">broom.mixed</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/broom.mixed/man/reexports.html">tidy</a></span>(<span class="no">mod_sim</span>)
}</pre></body></html></div>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="co"># run simulations</span>
<span class="no">prob2param</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">angry_ingroup</span> <span class="kw">=</span> <span class="fl">0</span>,
                       <span class="no">angry_outgroup</span> <span class="kw">=</span> <span class="fl">0</span>,
                       <span class="no">happy_ingroup</span> <span class="kw">=</span> <span class="fl">0</span>,
                       <span class="no">happy_outgroup</span> <span class="kw">=</span> <span class="fl">0</span>) {
  <span class="no">ai</span> <span class="kw">&lt;-</span> <span class="fu">logit</span>(<span class="no">angry_ingroup</span>)
  <span class="no">ao</span> <span class="kw">&lt;-</span> <span class="fu">logit</span>(<span class="no">angry_outgroup</span>)
  <span class="no">hi</span> <span class="kw">&lt;-</span> <span class="fu">logit</span>(<span class="no">happy_ingroup</span>)
  <span class="no">ho</span> <span class="kw">&lt;-</span> <span class="fu">logit</span>(<span class="no">happy_outgroup</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    <span class="kw">b0</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">ai</span>,<span class="no">ao</span>,<span class="no">hi</span>,<span class="no">ho</span>)),
    <span class="kw">b_cat</span> <span class="kw">=</span> (<span class="no">ao</span>+<span class="no">ho</span>) - (<span class="no">ai</span>+<span class="no">hi</span>),
    <span class="kw">b_exp</span> <span class="kw">=</span> (<span class="no">ao</span>+<span class="no">ai</span>) - (<span class="no">ho</span>+<span class="no">hi</span>),
    <span class="kw">b_cat_exp</span> <span class="kw">=</span> (<span class="no">ao</span>-<span class="no">ai</span>) - (<span class="no">ho</span>-<span class="no">hi</span>)
  )
}

<span class="no">reps</span> <span class="kw">&lt;-</span> <span class="fl">10</span>
<span class="no">b</span> <span class="kw">=</span> <span class="fu">prob2param</span>(<span class="fl">.5</span>, <span class="fl">.6</span>, <span class="fl">.4</span>, <span class="fl">.5</span>)

<span class="no">filename</span> <span class="kw">&lt;-</span> <span class="st">"sims/binomial2.csv"</span></pre></body></html></div>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="co"># run simulations and save to a file on each rep</span>
<span class="no">sims</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span>(<span class="no">reps</span>, {
  <span class="no">sim</span> <span class="kw">&lt;-</span> <span class="fu">ext_bin_func</span>(<span class="kw">b0</span> <span class="kw">=</span> <span class="no">b</span>$<span class="no">b0</span>,
                      <span class="kw">b_cat</span> <span class="kw">=</span> <span class="no">b</span>$<span class="no">b_cat</span>,
                      <span class="kw">b_exp</span> <span class="kw">=</span> <span class="no">b</span>$<span class="no">b_exp</span>,
                      <span class="kw">b_cat_exp</span> <span class="kw">=</span> <span class="no">b</span>$<span class="no">b_cat_exp</span>)
  <span class="co"># check if there are already simulations </span>
  <span class="co"># saved to file and add them</span>
  <span class="no">append</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span>(<span class="no">filename</span>)
  <span class="fu">write_csv</span>(<span class="no">sim</span>, <span class="no">filename</span>, <span class="kw">append</span> <span class="kw">=</span> <span class="no">append</span>)
})</pre></body></html></div>
</div>
<div id="calculate-mean-estimates" class="section level1">
<h1 class="hasAnchor">
<a href="#calculate-mean-estimates" class="anchor"></a>Calculate mean estimates</h1>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="co"># read saved simulation data</span>
<span class="no">sims</span> <span class="kw">&lt;-</span> <span class="fu">read_csv</span>(<span class="no">filename</span>)

<span class="no">est</span> <span class="kw">&lt;-</span> <span class="no">sims</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">effect</span> <span class="kw">==</span> <span class="st">"fixed"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">term</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise</span>(
    <span class="kw">mean_estimate</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">estimate</span>),
    <span class="kw">.groups</span> <span class="kw">=</span> <span class="st">"drop"</span>
  )

<span class="no">est</span> <span class="kw">%&gt;%</span> <span class="fu">mutate</span>(
  <span class="kw">sim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">b</span>$<span class="no">b0</span>, <span class="no">b</span>$<span class="no">b_cat</span>, <span class="no">b</span>$<span class="no">b_cat_exp</span>, <span class="no">b</span>$<span class="no">b_exp</span>)
) <span class="kw">%&gt;%</span>
  <span class="fu">mutate_if</span>(<span class="no">is.numeric</span>, <span class="no">round</span>, <span class="fl">2</span>)</pre></body></html></div>
<pre><code>## # A tibble: 4 x 3
##   term        mean_estimate   sim
##   &lt;chr&gt;               &lt;dbl&gt; &lt;dbl&gt;
## 1 (Intercept)          0.02  0   
## 2 cat                  0.71  0.81
## 3 cat:exp              0.22  0   
## 4 exp                  0.84  0.81</code></pre>
<div id="calculate-probabilities" class="section level3">
<h3 class="hasAnchor">
<a href="#calculate-probabilities" class="anchor"></a>Calculate probabilities</h3>
<p>Sum estimates for each cell and use inverse logit transform to recover probabilities.</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">int</span> <span class="kw">&lt;-</span> <span class="no">est</span><span class="kw">[[</span><span class="fl">1</span>,<span class="fl">2</span>]]
<span class="no">cat</span> <span class="kw">&lt;-</span> <span class="no">est</span><span class="kw">[[</span><span class="fl">2</span>,<span class="fl">2</span>]]
<span class="no">exp</span> <span class="kw">&lt;-</span> <span class="no">est</span><span class="kw">[[</span><span class="fl">4</span>,<span class="fl">2</span>]]
<span class="no">cat_exp</span> <span class="kw">&lt;-</span> <span class="no">est</span><span class="kw">[[</span><span class="fl">3</span>,<span class="fl">2</span>]]

<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">angry_outgroup</span> <span class="kw">=</span> <span class="fu">inv_logit</span>(<span class="no">int</span> + <span class="fl">.5</span>*<span class="no">cat</span> + <span class="fl">.5</span>*<span class="no">exp</span> + <span class="fl">.5</span>*<span class="fl">.5</span>*<span class="no">cat_exp</span>),
  <span class="kw">angry_ingroup</span>  <span class="kw">=</span> <span class="fu">inv_logit</span>(<span class="no">int</span> - <span class="fl">.5</span>*<span class="no">cat</span> + <span class="fl">.5</span>*<span class="no">exp</span> - <span class="fl">.5</span>*<span class="fl">.5</span>*<span class="no">cat_exp</span>),
  <span class="kw">happy_outgroup</span> <span class="kw">=</span> <span class="fu">inv_logit</span>(<span class="no">int</span> + <span class="fl">.5</span>*<span class="no">cat</span> - <span class="fl">.5</span>*<span class="no">exp</span> - <span class="fl">.5</span>*<span class="fl">.5</span>*<span class="no">cat_exp</span>),
  <span class="kw">happy_ingroup</span>  <span class="kw">=</span> <span class="fu">inv_logit</span>(<span class="no">int</span> - <span class="fl">.5</span>*<span class="no">cat</span> - <span class="fl">.5</span>*<span class="no">exp</span> + <span class="fl">.5</span>*<span class="fl">.5</span>*<span class="no">cat_exp</span>)
) <span class="kw">%&gt;%</span>
  <span class="fu">gather</span>(<span class="no">key</span>, <span class="no">val</span>, <span class="fl">1</span>:<span class="fl">4</span>) <span class="kw">%&gt;%</span>
  <span class="fu">separate</span>(<span class="no">key</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"exp"</span>, <span class="st">"cat"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">spread</span>(<span class="no">cat</span>, <span class="no">val</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate_if</span>(<span class="no">is.numeric</span>, <span class="no">round</span>, <span class="fl">2</span>)</pre></body></html></div>
<pre><code>##     exp ingroup outgroup
## 1 angry    0.51     0.70
## 2 happy    0.33     0.47</code></pre>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Lisa DeBruine, Dale Barr.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
