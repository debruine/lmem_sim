---
title: 'Appendix 2: Extended Example'
subtitle: "Understanding mixed effects models through data simulation"
author: "Lisa M. DeBruine & Dale J. Barr"

output: 
  html_notebook:
    toc: true
---

```{r, message=FALSE}
library("lme4")        # model specification / estimation
library("afex")        # anova and deriving p-values from lmer
library("broom.mixed") # extracting data from model fits 
library("faux")        # data simulation
# NOTE: to install the 'faux' package, use:
# devtools::install_github("debruine/faux")
library("tidyverse")   # data wrangling and visualisation

# set options for display in this R Markdown file
knitr::opts_chunk$set(echo       = TRUE,
                      fig.width  = 8,
                      fig.height = 5,
                      out.width  = "100%")

set.seed(90210)
```

### Set Study Parameters

In this example, 100 subjects will respond twice (for happy and angry expressions) to 50 items; 25 items in each of 2 categories. In this example, `expression` is a within-subject and within-item factor and `category` is a within-subject and between-item factor.

We will set our grand intercept and the fixed effect of category the same as before (800 ms and 50ms). We will predict that classification speed will be faster for angry than happy outgroup faces, and faster for happy than angy ingroup faces, but these effects will cancel each other out, so there will be no main effect of expression, just an interaction between category and expression, which we will set at 

Therefore, you will need to set up more complicated random effect parameters. Items and subjects will need standard deviations assigned for their random intercepts and the random slopes for any within factors (and their interactions), plus the correlations among all these SDs.

Since all subjects respond to all items, we can set up a table of trials by crossing the subject IDs with the item IDs and also any factors that are within-subject *and* within-item (i., `expression = c("happy", "angry")`). This is set up as a factor with the levels specified so they are displayed in the right order in plots.

```{r}

ext_sim_data <- function(
  nsubj        = 100, # number of subjects/btwn-grp
  nitem        =  25, # number of items/btwn-grp
  b0           = 800, # grand mean
  b_cat        =  50, # main effect of category
  b_exp        =   0, # main effect of expression
  b_cat_exp    =  40, # interaction between category and expression
  I0i_sd       =  80, # by-item random intercept sd
  Iexp_sd      =  60, # by-item random slope for exp
  icor         = 0.2, # by-item random effect correlation
  S0s_sd       = 100, # by-subject random intercept sd
  Scat_sd      =  40, # by-subject random slope sd for category
  Sexp_sd      =  80, # by-subject random slope sd for exp
  Scat_exp_sd  =  80, # by-subject random slope sd for category*exp
  # by-subject random effect correlations
  scor         = c(.3, .3, .3,   # S0s  * cat, exp, tc
                       .1, .1,   # cat  *      exp, tc
                           .1),  # exp *            tc
  err_sd       = 200   # residual (error) sd
) {

  # simulate items
  items <- faux::sim_design(
    within  = list(components = c("I0i", "Iexp")),
    between = list(category = c("ingroup", "outgroup")),
    n = nitem,
    sd = data.frame(I0i = I0i_sd, 
                    Iexp = Iexp_sd),
    r = icor,
    id = "item_id",
    plot = FALSE
  )

  # simulate subjects
  subjects <- faux::sim_design(
    within = list(components = c("S0s", "Scat", "Sexp", "Scat_exp")), 
    n = nsubj,
    sd = c(S0s  = S0s_sd,
           Scat = Scat_sd, 
           Sexp = Sexp_sd, 
           Scat.exp  = Scat_exp_sd), 
    r = scor,
    id = "subj_id",
    plot = FALSE
  )

  # simulate trials
  dat_sim <- crossing(
    subj_id = subjects$subj_id,
    item_id = items$item_id,
    expression = factor(c("happy", "angry"), ordered = TRUE)
  ) %>%
    inner_join(subjects, "subj_id") %>%
    inner_join(items, "item_id") %>%
    mutate(exp = recode(expression, "happy" = -0.5, "angry" = 0.5),
           cat = recode(category, "ingroup" = -0.5, "outgroup" = +0.5),
           trial_i    = b0 + I0i +  S0s,
           trial_cat  = b_cat + Scat,
           trial_exp  = b_exp + Iexp + Sexp,
           trial_ct   = b_cat_exp + Scat.exp,
           err = rnorm(nrow(.), mean = 0, sd = err_sd),
           RT = trial_i + 
             (trial_cat*cat) + 
             (trial_exp*exp) + 
             (trial_ct*cat*exp) + err)
  
  dat_sim
}
```

Plot your data to double-check it looks like you expect.

```{r}
dat_sim <- ext_sim_data()

ggplot(dat_sim, aes(expression, RT, color = category)) +
  geom_boxplot(width = 0.25, position = position_dodge(width = 0.9))
```


### Analyse Data


```{r}
ext_sim_func <- function(...) {
  
  dat_sim <- ext_sim_data(...)
  
  mod_sim <- lmer(RT ~ 1 + cat*exp + 
                    (1 + exp | item_id) + 
                    (1 + cat*exp | subj_id),
                  data = dat_sim, REML = TRUE)
  
  broom.mixed::tidy(mod_sim)
}
```

Run the function once with default parameters. 

```{r}
ext_sim_func()
```

## Power Analysis

```{r, eval = TRUE}
reps <- 10
sims <- purrr::map_df(1:reps, ~ext_sim_func())
write_csv(sims, "sims/ext_sims.csv")
```

```{r}
sims <- read_csv("sims/ext_sims.csv", col_types = cols(
  # makes sure plots display in this order
  group = col_factor(ordered = TRUE),
  term = col_factor(ordered = TRUE)
))
```

You can use these data to calculate power for each fixed effect or plot the distribution of your fixed or random effects.

```{r}
# calculate mean estimates and power for specified alpha
alpha <- 0.05

sims %>% 
  filter(effect == "fixed") %>%
  group_by(term) %>%
  summarise(
    mean_estimate = mean(estimate),
    mean_se = mean(std.error),
    power = mean(p.value < alpha)
  )
```

```{r, fig.cap = "Distribution of fixed effects across simulations"}
sim_stats <- sims %>% 
  filter(effect == "fixed") %>%
  group_by(term) %>%
  summarise(
    xval = mean(estimate) - 2.5*sd(estimate),
    value = mean(estimate)
  )

sims %>%
  filter(effect == "fixed") %>%
  mutate(significant = (p.value < alpha) %>% factor(levels = c(TRUE, FALSE))) %>%
  ggplot() +
  geom_density(aes(estimate, y = ..count.., fill = significant, color = significant), alpha = 0.5) +
  geom_vline(data = sim_stats, aes(xintercept = value), color = "grey40", show.legend = FALSE) +
  facet_wrap(~term, ncol = 1, scales = "free_x") + theme_bw()
```



```{r, fig.height = 10, fig.cap = "Distribution of random effects across simulations"}

sim_stats <- sims %>%
  filter(effect == "ran_pars") %>%
  group_by(group, term) %>%
  summarise(value = mean(estimate))

sims %>%
  filter(effect == "ran_pars") %>%
  ggplot(aes(estimate, color = paste(group, term), fill = paste(group, term))) +
  geom_density(alpha = 0.5, show.legend = FALSE) +
  geom_vline(data = sim_stats, aes(xintercept = value, color = paste(group, term)), show.legend = FALSE) +
  facet_wrap(~group*term, ncol = 3, scales = "free") + 
  theme_bw()
```













